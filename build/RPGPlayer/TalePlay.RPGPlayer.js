(function(t,e,s){var i=s("Layer"),n=t.getModule("shortcut")({det:"Detached",rj:"Request.json",debug:"debug",idb:"IDBConn",Map:"GUI.Map",Dialog:"GUI.Dialog",GameSave:"RPGPlayer.GameSave"}),o={quests:{loaded:function(t,e){for(var s=0;t.length>s;s++){var i=new a.Quest(t[s]);e.quests.set(i.name,i)}return e},error:function(t){return n.debug(["Could not load Quests: ",t],0),t}},dialogs:{loaded:function(t,e){for(var s=0;t.length>s;s++)e.dialogs.set(t[s].name,t[s]);return e},error:function(t){return n.debug(["Could not load Dialogs: ",t],0),t}}},a=i.RPGPlayer=t.Class(i,{init:function(t){if(t=t||{},this.superInit(i,t),this.domElement.classList.add("RPGPlayer"),!t.board)throw"board is undefined";if(t.board.addLayer(this),!t.gameName)throw"gameName is undefined";this.gameName=t.gameName,this.domElement.dataset.gamename=this.gameName,this.dbConn=new n.idb(this.gameName),this.createListener("ready quest-activate quest-complete quest-abort"),this.baseUrl=t.baseUrl||"",this.imageBaseUrl=t.imageBaseUrl||t.baseUrl||"",this.mapBaseUrl=t.mapBaseUrl||t.baseUrl||"",this.cursor=new n.Map.Cursor,this.quests=new Map,this.activeQuests=new Map,this.questsReady=n.rj(this.baseUrl+"quests.json",this).then(o.quests.loaded,o.quests.error),this.dialogs=new Map,n.rj(this.baseUrl+"dialogs.json",this).then(o.dialogs.loaded,o.dialogs.error),this.focused=null,this.mapName=null,this.map=new n.Map,this.map.addListener("trigger",this,"_onTrigger"),this._StartMenu="function"==typeof t.startMenu?t.startMenu:s(t.startMenu||"StartMenu"),this._GameMenu="function"==typeof t.gameMenu?t.gameMenu:s(t.gameMenu||"RPGPlayer.GameMenu"),this._openStartMenu()},_openStartMenu:function(){this.focused=null;var t=new this._StartMenu({dbConn:this.dbConn,saveClass:n.GameSave,saveConverter:a.saveConverter,newGameUrl:this.baseUrl+"newgame.json"});t.addListener("start:once",this,function(t){t.source.destroy(),this.focused=this.map,this.has(this.map)||this.add(this.map),this.loadSave(t.save)}),this.board.addLayer(t)},_openGameMenu:function(t){this.map.movingCursors["delete"](this.cursor),this.map.setPaused(!0),this.focused=null;var e=new this._GameMenu({dbConn:this.dbConn,saveClass:n.GameSave,saveConverter:a.saveConverter,saveData:t?this.getSave():null});e.addListener("close:once",this,function(t){t.source.destroy(),this.focused=this.map,this.map.setPaused(!1)}),this.board.addLayer(e)},onController:function(t){if(this.focused)if(this.focused===this.map&&"buttonChanged"===t.type)switch(t.index){case 1:case 2:this.focused[i._CONTROLLER_EVENT_MAP[t.type]](t);break;case 3:1==t.value&&this._openGameMenu()}else this.focused[i._CONTROLLER_EVENT_MAP[t.type]](t)},loadSave:function(t){this.setCursor(t.getCursor()),this.questsReady.complete(function(e){for(var s=[],i=0;t.getQuests().length>i;i++)if(e.quests.has(t.getQuests()[i])){var n=e.quests.get(t.getQuests()[i]).clone();e.activeQuests.set(n.name,n),s.push(n.name)}return s}),this._changeMap(t.getMap(),t.getPosition()),t.getActions()&&this.doActions(t.getActions())},setCursor:function(t){var e=this.imageBaseUrl;t.urls=t.urls.map(function(t){return t?e+t:t}),t.name=t.name||"",t.collision=t.collision!==!1,this.cursor.fromJSON(t)},getSave:function(){var t={gameName:this.gameName,cursor:this.cursor.toJSON(),map:this.mapName,position:this.cursor.getPosition(),quests:[]};t.cursor.urls.map(function(t){return t?t.slice(t.lastIndexOf("/")+1):t});for(var e=this.activeQuests.entries(),s=null;s=e.next(),!s.done;)t.quests.push(s.value[0]);return new n.GameSave(t)},_changeMap:function(t,e){return this.map.setPaused(!0),n.rj(this.mapBaseUrl+t+".json",this).then(function(s,i){for(var n=s.cursors.concat(s.images);n.length>0;){var o=n.shift();o.url=i.imageBaseUrl+o.url}s.position=e;var a=i.map.movingCursors.get(i.cursor);return i.map.fromJSON(s),i.cursor.setPosition(e),i.map.add(i.cursor),a&&i.map.movingCursors.set(i.cursor,a),i.map.setPaused(!1),i.mapName=t,t},function(e){return n.debug(["Could not load Map: ",t,e],0),e})},_stopCursor:function(){this.cursor.direction&&this.cursor.direction.set(0)},_showDialog:function(t){var e=this.dialogs.get(t);e&&(e.styleClass="panel",this.focused=new n.Dialog(e),this.focused.addListener("dialogEnd:once",this,function(t){this.focused.destroy(),this.focused=this.map,t.actions&&this.doActions(t.actions)}),this.add(this.focused),this._stopCursor())},_onTrigger:function(t){this.doActions(t.value)},doActions:function(e){for(var s=0;e.length>s;s++){var i=e[s],n=null;switch(i.type){case"ABORT_QUEST":n=this.activeQuests.get(i.questName),n&&(this.activeQuests["delete"](i.questName),this.fire("quest-abort",{value:n}));break;case"RESOLVE_QUEST":n=this.activeQuests.get(i.questName),n&&(this.activeQuests["delete"](i.questName),this.fire("quest-complete",{value:n}),e=e.concat(n.resolve));break;case"ACTIVATE_QUEST":n=this.quests.get(i.questName),n&&(n=n.clone(),this.activeQuests.set(n.name,n),this.fire("quest-activate",{value:n}));break;case"CHANGE_MAP":this._changeMap(i.mapName,i.position);break;case"SHOW_DIALOG":this._showDialog(i.dialogName);break;case"OPEN_GAMEMENU":this._openGameMenu(i.enableSave);break;case"EXECUTE":try{i.value(this)}catch(o){t.debug(["doAction Error: ",i,o],0)}}}}});a.saveConverter=function(t,e){if(!t)return[e,"EMPTY","&nbsp;"];try{return[e,t.getTimeStamp().toLocaleString(),t.getMap()]}catch(s){return n.debug([s,t],n.debug.LEVEL.ERROR),[e,"CORRUPT DATA","&nbsp;"]}},e("RPGPlayer",a),a.Quest=t.Class({init:function(t){t=t||{},this.name=t.name||"NO NAME!",this.description=t.description||"NO DESCRIPTION!",this.resolve=t.resolve||[]},clone:function(t){return t||(t=new a.Quest),t.name=this.name,t.description=this.description,t.resolve=this.resolve.slice(),t}}),e("RPGPlayer.Quest",a.Quest)})(Morgas,Morgas.setModule,Morgas.getModule);