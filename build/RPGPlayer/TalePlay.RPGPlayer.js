(function(t,e,i){var s=i("Layer"),n=t.getModule("shortcut")({det:"Detached",rj:"Request.json",debug:"debug",idb:"IDBConn",Map:"GUI.Map",Dialog:"GUI.Dialog",GameSave:"RPGPlayer.GameSave"}),a={quests:{loaded:function(t,e){for(var i=0;t.length>i;i++){var s=new o.Quest(t[i]);e.quests.set(s.name,s)}return e},error:function(t){return n.debug(["Could not load Quests: ",t],0),t}},dialogs:{loaded:function(t,e){for(var i=0;t.length>i;i++)e.dialogs.set(t[i].name,t[i]);return e},error:function(t){return n.debug(["Could not load Dialogs: ",t],0),t}}},o=s.RPGPlayer=t.Class(s,{init:function(t){if(t=t||{},this.superInit(s,t),this.domElement.classList.add("RPGPlayer"),!t.board)throw"board is undefined";if(t.board.addLayer(this),!t.gameName)throw"gameName is undefined";this.gameName=t.gameName,this.domElement.dataset.gamename=this.gameName,this.dbConn=new n.idb(this.gameName),this.createListener("ready quest-activate quest-complete quest-abort execute"),this.baseUrl=t.baseUrl||"",this.imageBaseUrl=t.imageBaseUrl||t.baseUrl||"",this.mapBaseUrl=t.mapBaseUrl||t.baseUrl||"",this.gameSave=new n.GameSave({cursor:new n.Map.Cursor}),this.quests=new Map,this.questsReady=n.rj(this.baseUrl+"quests.json",this).then(a.quests.loaded,a.quests.error),this.dialogs=new Map,n.rj(this.baseUrl+"dialogs.json",this).then(a.dialogs.loaded,a.dialogs.error),this.focused=null,this.map=new n.Map,this.map.addListener("trigger",this,"_onTrigger"),this._StartMenu="function"==typeof t.startMenu?t.startMenu:i(t.startMenu||"StartMenu"),this._GameMenu="function"==typeof t.gameMenu?t.gameMenu:i(t.gameMenu||"RPGPlayer.GameMenu"),this._openStartMenu()},_openStartMenu:function(){this.focused=null;var t=new this._StartMenu({dbConn:this.dbConn,saveClass:n.GameSave,saveConverter:o.saveConverter,newGameUrl:this.baseUrl+"newgame.json"});t.addListener("start:once",this,function(t){t.source.destroy(),this.focused=this.map,this.has(this.map)||this.add(this.map),this.loadSave(t.save)}),this.board.addLayer(t)},_openGameMenu:function(t){this.map.movingCursors["delete"](this.gameSave.getCursor()),this.map.setPaused(!0),this.focused=null;var e=new this._GameMenu({dbConn:this.dbConn,saveClass:n.GameSave,saveConverter:o.saveConverter,saveData:t?this.getSave():null});e.addListener("close:once",this,function(t){t.source.destroy(),this.focused=this.map,this.map.setPaused(!1)}),this.board.addLayer(e)},onController:function(t){if(this.focused)if(this.focused===this.map&&"buttonChanged"===t.type)switch(t.index){case 1:case 2:this.focused[s._CONTROLLER_EVENT_MAP[t.type]](t);break;case 3:1==t.value&&this._openGameMenu()}else this.focused[s._CONTROLLER_EVENT_MAP[t.type]](t)},loadSave:function(t){this.setCursor(t.getCursor());var e=this.gameSave.getQuests();e.length=0,this.questsReady.complete(function(i){for(var s=t.getQuests(),a=0;s.length>a;a++)i.quests.has(s[a])?-1===e.indexOf(s[a])&&e.push(s[a]):n.debug("quest "+s[a]+" not found",n.debug.LEVE.ERROR);return null}),this._changeMap(t.getMap(),t.getPosition()),t.getActions()&&this.doActions(t.getActions())},setCursor:function(t){var e=this;t.urls=t.urls.map(function(t){return t?e.imageBaseUrl+t:t}),t.name=t.name||"",t.collision=t.collision!==!1,this.gameSave.getCursor().fromJSON(t)},getSave:function(){this.gameSave.setTimeStamp(new Date),this.gameSave.setPosition(this.gameSave.getCursor().getPosition());var t=new n.GameSave;t.fromJSON(JSON.parse(JSON.stringify(this.gameSave)));var e=t.getCursor();return e.urls=e.urls.map(function(t){return t?t.slice(t.lastIndexOf("/")+1):t}),t},_changeMap:function(t,e){return this.map.setPaused(!0),n.rj(this.mapBaseUrl+t+".json",this).then(function(i,s){for(var n=i.cursors.concat(i.images);n.length>0;){var a=n.shift();a.url=s.imageBaseUrl+a.url}i.position=e;var o=s.map.movingCursors.get(s.gameSave.getCursor());return s.map.fromJSON(i),s.gameSave.getCursor().setPosition(e),s.map.add(s.gameSave.getCursor()),o&&s.map.movingCursors.set(s.gameSave.getCursor(),o),s.map.setPaused(!1),s.gameSave.setMap(t),t},function(e){return n.debug(["Could not load Map: ",t,e],0),e})},_stopCursor:function(){this.gameSave.getCursor().direction&&this.gameSave.getCursor().direction.set(0)},_showDialog:function(t){var e=this.dialogs.get(t);e&&(e.styleClass="panel",this.focused=new n.Dialog(e),this.focused.addListener("dialogEnd:once",this,function(t){this.focused.destroy(),this.focused=this.map,t.actions&&this.doActions(t.actions)}),this.add(this.focused),this._stopCursor())},_onTrigger:function(t){this.doActions(t.value)},doActions:function(t){for(var e=0;t.length>e;e++){var i=t[e],s=this.gameSave.getQuests(),n=null,a=null;switch(i.type){case"ABORT_QUEST":-1!==(n=s.indexOf(i.questName))&&(a=this.quests.get(i.questName)),a&&(s.splice(n,1),this.fire("quest-abort",{value:a}));break;case"RESOLVE_QUEST":-1!==(n=s.indexOf(i.questName))&&(a=this.quests.get(i.questName)),a&&(s.splice(n,1),this.fire("quest-complete",{value:a}),t=t.concat(a.resolve));break;case"ACTIVATE_QUEST":a=this.quests.get(i.questName),a&&-1===s.indexOf(i.questName)&&(s.push(i.questName),this.fire("quest-activate",{value:a}));break;case"CHANGE_MAP":this._changeMap(i.mapName,i.position);break;case"SHOW_DIALOG":this._showDialog(i.dialogName);break;case"OPEN_GAMEMENU":this._openGameMenu(i.enableSave);break;case"EXECUTE":this.fire("execute",{action:i})}}}});o.saveConverter=function(t,e){if(!t)return[e,"EMPTY","&nbsp;"];try{return[e,t.getTimeStamp().toLocaleString(),t.getMap()]}catch(i){return n.debug([i,t],n.debug.LEVEL.ERROR),[e,"CORRUPT DATA","&nbsp;"]}},e("RPGPlayer",o),o.Quest=t.Class({init:function(t){t=t||{},this.name=t.name||"NO NAME!",this.description=t.description||"NO DESCRIPTION!",this.resolve=t.resolve||[]},clone:function(t){return t||(t=new o.Quest),t.name=this.name,t.description=this.description,t.resolve=this.resolve.slice(),t},toJSON:function(){return this.name}}),e("RPGPlayer.Quest",o.Quest)})(Morgas,Morgas.setModule,Morgas.getModule);