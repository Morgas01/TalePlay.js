//Morgas/src/Morgas.js
(function(e){Morgas={version:"0.3"},µ=Morgas,µ.revert=function(){return µ=e},µ.constantFunctions={ndef:function(){return void 0},nul:function(){return null},f:function(){return!1},t:function(){return!0},zero:function(){return 0},"boolean":function(e){return!!e}},function(){var e={};µ.setModule=function(t,n){return e[t]&&µ.debug("module "+t+" is overwritten",2),e[t]=n},µ.hasModule=function(t){return!!e[t]},µ.getModule=function(t){return e[t]||µ.debug("module "+t+" is not defined\n use µ.hasModule to check for existence",0),e[t]}}();var t=µ.setModule,n=µ.getModule,o=µ.hasModule;µ.debug=function(e,t){t||(t=0),µ.debug.verbose!==!1&&µ.debug.verbose>=t&&("function"==typeof e&&(e=e()),µ.debug.out(e,t))},t("debug",µ.debug),µ.debug.LEVEL={OFF:!1,ERROR:0,WARNING:1,INFO:2,DEBUG:3},µ.debug.verbose=µ.debug.LEVEL.WARNING,µ.getDebug=function(e){µ.debug.verbose=e},µ.setDebug=function(e){µ.debug.verbose=e},µ.debug.out=function(e,t){switch(t){case 0:console.error(e);break;case 1:console.warn(e);break;case 2:console.info(e);break;case 3:default:console.log(e)}},µ.shortcut=function(e,t,u,r){t||(t={});for(var i in e)(function(e,i){var s=void 0;Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:function(){return(null==s||r)&&("function"==typeof e?s=e(u):u&&o("goPath")?s=n("goPath")(u,e):o(e)?s=n(e):n("debug")("shortcut: could not evaluate "+e)),s}})})(e[i],i);return t},t("shortcut",µ.shortcut);var u=µ.Class=function(e,t){var u=function(){this.init.apply(this,arguments),o("Listeners")&&this instanceof n("Listeners")&&this.setState(".created")};"function"!=typeof e&&(t=e,e=r),e&&(u.prototype=Object.create(e.prototype),u.prototype.constructor=u);for(var i in t)u.prototype[i]=t[i];return u};t("Class",u);var r=µ.BaseClass=u({init:function(){},superInit:function(e){e.prototype.init.apply(this,[].slice.call(arguments,1))},superInitApply:function(e,t){this.superInit.apply(this,[e].concat([].slice.call(t)))}});t("Base",r)})(this.µ);
//Morgas/src/Morgas.Listeners.js
(function(t,e){var s=t.Listener=t.Class({init:function(){this.listeners=new Map,this.disabled=!1},addListener:function(t,e,s){var n=typeof t;if("function"===n||"string"===n){e=e||this;var i=null;if(this.listeners.has(e)){if(i=this.listeners.get(e),i.first.has(t)||i.normal.has(t)||i.last.has(t)||i.once.has(t))return null}else i={first:new Set,normal:new Set,last:new Set,once:new Set},this.listeners.set(e,i);switch(s&&(s=s.toLowerCase()),s){case"first":i.first.add(t);break;default:i.normal.add(t);break;case"last":i.last.add(t);break;case"once":i.once.add(t)}return t}return null},addListeners:function(t,e,s){t=[].concat(t);for(var n=[],i=0;t.length>i;i++)n.push(this.addListener(t[i],e,s));return n},removeListener:function(t,e){var s=0,n=this.listeners.get(e);return n?("string"==typeof t&&"all"==t.toLowerCase()?(s=n.first.size+n.normal.size+n.last.size+n.once.size,this.listeners.delete(e)):(n.first.delete(t)&&s++,n.normal.delete(t)&&s++,n.last.delete(t)&&s++,n.once.delete(t)&&s++,0===n.first.size&&0===n.normal.size&&0===n.last.size&&0===n.once.size&&this.listeners.delete(e)),s):"string"==typeof t&&"all"==t.toLowerCase()&&void 0===e?(this.listeners.clear(),-1):null},removeListeners:function(t,e){t=[].concat(t);var s=[];0==t.length&&t.push("all");for(var n=0;t.length>n;n++)s.push(this.removeListener(t[n],e));return s},fire:function(t,e){if(e=e||{},e.source=t,!this.disabled){for(var s=!0,n=this.listeners.entries(),i=null;i=n.next(),!i.done;){for(var r=i.value[0],a=i.value[1],o=a.first.values(),l=void 0,u=void 0;s&&(l=o.next(),u=l.value,!l.done);)"string"==typeof u&&(u=r[u]),s=!1!==u.call(r,e);for(o=a.normal.values();s&&(l=o.next(),u=l.value,!l.done);)"string"==typeof u&&(u=r[u]),s=!1!==u.call(r,e);for(o=a.last.values();s&&(l=o.next(),u=l.value,!l.done);)"string"==typeof u&&(u=r[u]),s=!1!==u.call(r,e);for(o=a.once.values();l=o.next(),u=l.value,!l.done;)"string"==typeof u&&(u=r[u]),u.call(r,e);a.once.clear(),0===a.first.size&&0===a.normal.size&&0===a.last.size&&this.listeners["delete"](r)}return s}return null},setDisabled:function(t){this.disabled=t===!0},isDisabled:function(){return this.disabled}});e("Listener",s);var n=s.StateListener=t.Class(s,{init:function(t){this.superInit(s),this.state=t.state===!0,this.stateDisabled=!1,this.lastEvent=null},setDisabled:function(t){this.stateDisabled=t===!0},isDisabled:function(){return this.stateDisabled},setState:function(t,e){e=e||{},e.source=t,this.state=!0,this.lastEvent=e;var s=!1;return this.stateDisabled||(this.disabled=!1,s=this.fire.apply(this,this.lastEvent),this.disabled=!0),s},resetState:function(){this.state=!1},getState:function(){return this.state},addListener:function(t,e,n){var i=this.state&&!this.stateDisabled;return i&&t.apply(e,this.lastEvent),i&&"string"==typeof n&&"once"==n.toLowerCase()?null:s.prototype.addListener.apply(this,arguments)}});e("StateListener",n);var i=t.Listeners=t.Class({rNames:/[\s|,]+/,rNameopt:":",init:function(){this.listeners={},this.createListener(".created")},createListener:function(t){var e=t.split(this.rNames);[].slice.call(arguments,1);for(var i=0;e.length>i;i++){var r=e[i].split(this.rNameopt);null==this.listeners[r[0]]&&(this.listeners[r[0]]="."==r[0][0]?new n({}):new s({}))}},addListener:function(t,e){for(var s=t.split(this.rNames),n=[].slice.call(arguments,2),i=0;s.length>i;i++){var r=s[i].split(this.rNameopt);void 0!==this.listeners[r[0]]&&this.listeners[r[0]].addListeners(n,e,r[1])}},removeListener:function(t,e){var s=0;if("all"==t.toLowerCase())for(var n in this.listeners)s+=this.listeners[n].removeListeners(t,e);else for(var i=t.split(this.rNames),r=[].slice.call(arguments,2),n=0;i.length>n;n++){var a=i[n];void 0!==this.listeners[a]&&(s+=this.listeners[a].removeListeners(r,e))}return s},fire:function(t,e){return e=e||{},e.type=t,this.listeners[t]?this.listeners[t].fire(this,e):void 0},setDisabled:function(t,e){for(var s=t.split(this.rNames),n=0;s.length>n;n++){var i=this.listeners[s[n]];null!=i&&i.setDisabled(e)}},isDisabled:function(t){for(var e=!0,s=t.split(this.rNames),n=0;e&&s.length>n;n++){var i=this.listeners[s[n]];null!=i&&(e&=i.isDisabled())}return e},setState:function(t,e){e=e||{},e.type=t;var s=this.listeners[t];return s&&s instanceof n?s.setState(this,e):void 0},resetState:function(t){for(var e=t.split(this.rNames),s=0;e.length>s;s++){var i=this.listeners[e[s]];null!=i&&i instanceof n&&i.resetState()}},getState:function(t){for(var e=!0,s=t.split(this.rNames),i=0;e&&s.length>i;i++){var r=this.listeners[s[i]];null!=r&&r instanceof n&&(e&=r.getState())}return e},destroy:function(){this.removeListener("all")}});e("Listeners",i),i.attachListeners=function(t){for(var e in i.prototype)"init"!=e&&"constructor"!=e&&"superInit"!=e&&"superInitApply"!=e&&(t[e]=i.prototype[e]);i.prototype.init.call(t),t.setState(".created")},e("attachListeners",i.attachListeners)})(Morgas,Morgas.setModule,Morgas.getModule);
//TalePlay.Layer.js
(function(e,t,o,r){var s=window.TalePlay=window.TalePlay||{},l=o("Listeners"),n=o("shortcut")({node:"NodePatch"}),a=s.Layer=e.Class(l,{init:function(e){this.superInit(l),e=e||{},this.nodePatch=new n.node(this,{parent:"board",children:"GUIElements",addChild:"add",removeChild:"remove",hasChild:"has"},!0),this.mode=e.mode||a.Modes.ALL,this.domElement=document.createElement("div"),this.domElement.classList.add("Layer"),this.focused=null},onController:function(e){switch(this.mode){case a.Modes.ALL:default:for(var t=0;this.GUIElements.length>t;t++)this.GUIElements[t][a._CONTROLLER_EVENT_MAP[e.type]](e);break;case a.Modes.FIRST:this.GUIElements.length>0&&this.GUIElements[0][a._CONTROLLER_EVENT_MAP[e.type]](e);break;case a.Modes.LAST:this.GUIElements.length>0&&this.GUIElements[this.GUIElements.length-1][a._CONTROLLER_EVENT_MAP[e.type]](e);break;case a.Modes.FOCUSED:this.focused&&this.focused[a._CONTROLLER_EVENT_MAP[e.type]](e)}},add:function(e,t){return r("GUIElement")&&e instanceof o("GUIElement")&&this.nodePatch.addChild(e)?("string"==typeof t&&(t=this.domElement.querySelector(t)),t||(t=this.domElement),t.appendChild(e.domElement),!0):!1},remove:function(e){return this.nodePatch.removeChild(e)?(e.domElement.remove(),e.removeListener("all",this),!0):!1},destroy:function(){this.nodePatch.remove();for(var e=this.GUIElements.slice(),t=0;e.length>t;t++)e[t].destroy();l.prototype.destroy.call(this)}});a.Modes={ALL:0,FIRST:1,LAST:2,FOCUSED:3},a._CONTROLLER_EVENT_MAP={analogStickChanged:"onAnalogStick",buttonChanged:"onButton"},t("Layer",a)})(Morgas,Morgas.setModule,Morgas.getModule,Morgas.hasModule);
//RPGPlayer/TalePlay.RPGPlayer.js
(function(t,e,s){var i=s("Layer"),n=t.getModule("shortcut")({det:"Detached",rj:"Request.json",debug:"debug",idb:"IDBConn",Map:"GUI.Map",Dialog:"GUI.Dialog",GameSave:"RPGPlayer.GameSave"}),o={quests:{loaded:function(t,e){for(var s=0;t.length>s;s++){var i=new a.Quest(t[s]);e.quests.set(i.name,i)}return e},error:function(t){return n.debug(["Could not load Quests: ",t],0),t}},dialogs:{loaded:function(t,e){for(var s=0;t.length>s;s++)e.dialogs.set(t[s].name,t[s]);return e},error:function(t){return n.debug(["Could not load Dialogs: ",t],0),t}}},a=i.RPGPlayer=t.Class(i,{init:function(t){if(t=t||{},this.superInit(i,t),this.domElement.classList.add("RPGPlayer"),!t.board)throw"board is undefined";if(t.board.addLayer(this),!t.gameName)throw"gameName is undefined";this.gameName=t.gameName,this.domElement.dataset.gamename=this.gameName,this.dbConn=new n.idb(this.gameName),this.createListener("ready quest-activate quest-complete quest-abort"),this.baseUrl=t.baseUrl||"",this.imageBaseUrl=t.imageBaseUrl||t.baseUrl||"",this.mapBaseUrl=t.mapBaseUrl||t.baseUrl||"",this.cursor=new n.Map.Cursor,this.quests=new Map,this.activeQuests=new Map,this.questsReady=n.rj(this.baseUrl+"quests.json",this).then(o.quests.loaded,o.quests.error),this.dialogs=new Map,n.rj(this.baseUrl+"dialogs.json",this).then(o.dialogs.loaded,o.dialogs.error),this.focused=null,this.mapName=null,this.map=new n.Map,this.map.addListener("trigger",this,"_onTrigger"),this._StartMenu="function"==typeof t.startMenu?t.startMenu:s(t.startMenu||"StartMenu"),this._GameMenu="function"==typeof t.gameMenu?t.gameMenu:s(t.gameMenu||"RPGPlayer.GameMenu"),this._openStartMenu()},_openStartMenu:function(){this.focused=null;var t=new this._StartMenu({dbConn:this.dbConn,saveClass:n.GameSave,saveConverter:a.saveConverter,newGameUrl:this.baseUrl+"newgame.json"});t.addListener("start:once",this,function(t){t.source.destroy(),this.focused=this.map,this.has(this.map)||this.add(this.map),this.loadSave(t.save)}),this.board.addLayer(t)},_openGameMenu:function(t){this.map.movingCursors["delete"](this.cursor),this.map.setPaused(!0),this.focused=null;var e=new this._GameMenu({dbConn:this.dbConn,saveClass:n.GameSave,saveConverter:a.saveConverter,saveData:t?this.getSave():null});e.addListener("close:once",this,function(t){t.source.destroy(),this.focused=this.map,this.map.setPaused(!1)}),this.board.addLayer(e)},onController:function(t){if(this.focused)if(this.focused===this.map&&"buttonChanged"===t.type)switch(t.index){case 1:case 2:this.focused[i._CONTROLLER_EVENT_MAP[t.type]](t);break;case 3:1==t.value&&this._openGameMenu()}else this.focused[i._CONTROLLER_EVENT_MAP[t.type]](t)},loadSave:function(t){this.cursor.url=this.imageBaseUrl+t.getCursor().url,this.cursor.name=t.getCursor().name||"",this.cursor.rect.size.set(t.getCursor().size),this.cursor.offset.set(t.getCursor().offset),this.cursor.speed.set(t.getCursor().speed),this.cursor.collision=t.getCursor().collision!==!1,this.questsReady.complete(function(e){for(var s=[],i=0;t.getQuests().length>i;i++)if(e.quests.has(t.getQuests()[i])){var n=e.quests.get(t.getQuests()[i]).clone();e.activeQuests.set(n.name,n),s.push(n.name)}return s}),this._changeMap(t.getMap(),t.getPosition()),t.getActions()&&this.doActions(t.getActions())},getSave:function(){for(var t={gameName:this.gameName,cursor:{url:this.cursor.url.slice(this.cursor.url.lastIndexOf("/")+1),name:this.cursor.name,size:this.cursor.rect.size,offset:this.cursor.offset},map:this.mapName,position:this.cursor.getPosition(),quests:[]},e=this.activeQuests.entries(),s=null;s=e.next(),!s.done;)t.quests.push(s.value[0]);return new n.GameSave(t)},_changeMap:function(t,e){return this.map.setPaused(!0),n.rj(this.mapBaseUrl+t+".json",this).then(function(s,i){for(var n=s.cursors.concat(s.images);n.length>0;){var o=n.shift();o.url=i.imageBaseUrl+o.url}s.position=e;var a=i.map.movingCursors.get(i.cursor);return i.map.fromJSON(s),i.cursor.setPosition(e),i.map.add(i.cursor),a&&i.map.movingCursors.set(i.cursor,a),i.map.setPaused(!1),i.mapName=t,t},function(e){return n.debug(["Could not load Map: ",t,e],0),e})},_stopCursor:function(){this.cursor.direction&&this.cursor.direction.set(0)},_showDialog:function(t){var e=this.dialogs.get(t);e&&(e.styleClass="panel",this.focused=new n.Dialog(e),this.focused.addListener("dialogEnd:once",this,function(t){this.focused.destroy(),this.focused=this.map,t.actions&&this.doActions(t.actions)}),this.add(this.focused),this._stopCursor())},_onTrigger:function(t){this.doActions(t.value)},doActions:function(e){for(var s=0;e.length>s;s++){var i=e[s],n=null;switch(i.type){case"ABORT_QUEST":n=this.activeQuests.get(i.questName),n&&(this.activeQuests["delete"](i.questName),this.fire("quest-abort",{value:n}));break;case"RESOLVE_QUEST":n=this.activeQuests.get(i.questName),n&&(this.activeQuests["delete"](i.questName),this.fire("quest-complete",{value:n}),e=e.concat(n.resolve));break;case"ACTIVATE_QUEST":n=this.quests.get(i.questName),n&&(n=n.clone(),this.activeQuests.set(n.name,n),this.fire("quest-activate",{value:n}));break;case"CHANGE_MAP":this._changeMap(i.mapName,i.position);break;case"SHOW_DIALOG":this._showDialog(i.dialogName);break;case"OPEN_GAMEMENU":this._openGameMenu(i.enableSave);break;case"EXECUTE":try{i.value(this)}catch(o){t.debug(["doAction Error: ",i,o],0)}}}}});a.saveConverter=function(t,e){if(!t)return[e,"EMPTY","&nbsp;"];try{return[e,t.getTimeStamp().toLocaleString(),t.getMap()]}catch(s){return n.debug([s,t],n.debug.LEVEL.ERROR),[e,"CORRUPT DATA","&nbsp;"]}},e("RPGPlayer",a),a.Quest=t.Class({init:function(t){t=t||{},this.name=t.name||"NO NAME!",this.description=t.description||"NO DESCRIPTION!",this.resolve=t.resolve||[]},clone:function(t){return t||(t=new a.Quest),t.name=this.name,t.description=this.description,t.resolve=this.resolve.slice(),t}}),e("RPGPlayer.Quest",a.Quest)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.Detached.js
(function(t,e,s){var n=s("shortcut")({debug:"debug"}),r=function(t,e){return function(s,r){try{var i=t.apply({complete:s,error:r},e);i&&"function"==typeof i.then?i.then(s,r):void 0!==i&&s(i)}catch(a){n.debug(a,1),r(a)}}},i=t.Detached=t.Class({init:function(t,e){var s=t===i.WAIT;s&&(t=arguments[1]),this.fn=[].concat(t||[]),this.onError=[],this.onComplete=[],this.onAlways=[],this.onPropagate=[],this.status=0,this.args=void 0,s||(0===this.fn.length?this.status=1:this._start(e))},_start:function(t){for(var e=0;this.fn.length>e;e++)"function"==typeof this.fn[e]&&(this.fn[e]=new Promise(r(this.fn[e],t)));var s=this;Promise.all(this.fn).then(function(t){s._setStatus(1,t)},function(){s._setStatus(-1,Array.prototype.slice.call(arguments,0))})},_setStatus:function(t,e){if(this.status=t,this.args=e,1===t)for(;this.onComplete.length>0;)this.onComplete.shift()._start(this.args);else if(-1===t){for(;this.onError.length>0;)this.onError.shift()._start(this.args);for(;this.onPropagate.length>0;)this.onPropagate.shift()._setStatus(t,this.args)}for(var s=[1===this.status].concat(this.args);this.onAlways.length>0;)this.onAlways.shift()._start(s);this.onComplete.length=this.onError.length=this.onPropagate.length=this.onAlways.length=this.fn.length=0},error:function(t){t=[].concat(t);for(var e=0;t.length>e;e++)t[e]=new i(i.WAIT,t[e]),-1==this.status&&this.finished>=this.fn.length?t[e]._start(this.args):0===this.status&&this.onError.push(t[e]);return t[t.length-1]},complete:function(t){t=[].concat(t);for(var e=0;t.length>e;e++)t[e]=new i(i.WAIT,t[e]),1==this.status?t[e]._start(this.args):0==this.status&&this.onComplete.push(t[e]);return t[t.length-1]},then:function(t,e){var s=this.complete(t);return e===!0?this.propagateError(s):this.error(e),s},always:function(t){t=[].concat(t);for(var e=0;t.length>e;e++)if(t[e]=new i(i.WAIT,t[e]),0!==this.status){var s=[1===this.status].concat(this.args);t[e]._start(s)}else 0===this.status&&this.onAlways.push(t[e]);return t[t.length-1]},propagateError:function(t){0===this.status?this.onPropagate.push(t):-1===this.status&&0===t.status&&t._setStatus(-1,this.args)}});i.WAIT={},e("Detached",i),i.complete=function(){var t=new i;return t.args=arguments,t},i.error=function(){var t=new i;return t.status=-1,t.args=arguments,t},i.detache=function(t,e){return e=e||window,function(){var s=Array.prototype.slice.call(arguments,0);return new i(function(){s.unshift(this);try{return t.apply(e,s)}catch(r){n.debug(r,1),this.error(r)}})}},i.detacheAll=function(t,e){e=[].concat(e);for(var s=0;e.length>s;s++){var n=t[e[s]];t[e[s]]=i.detache(n,t)}}})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.util.Request.js
(function(e,t,n){e.util=e.util||{};var s=n("shortcut")({det:"Detached"});REQ=e.util.Request=function(e,t){return"string"==typeof e&&(e={url:e}),e={url:e.url,method:e.data?"POST":"GET",async:!0,user:e.user,password:e.password,responseType:e.responseType||"",upload:e.upload,withCredentials:e.withCredentials===!0,contentType:e.contentType,data:e.data},new s.det([function(){var t=this,n=new XMLHttpRequest;n.open(e.method,e.url,e.async,e.user,e.password),n.responseType=e.responseType,e.contentType?n.setRequestHeader("contentType",value):e.data&&(e.contentType="application/x-www-form-urlencoded;charset=UTF-8",e.data.consctuctor===Object&&(e.contentType="application/json;charset=UTF-8",e.data=JSON.stringify(data)),n.setRequestHeader("contentType",e.contentType)),e.upload&&(n.upload=e.upload),n.onload=function(){200==n.status?t.complete(n):t.error(n.statusText)},n.onerror=function(){t.error("Network Error")},e.progress&&(n.onprogress=e.progress),n.send(e.data)},t])},t("Request",REQ),REQ.json=function(e,t){"string"==typeof e&&(e={url:e}),e.responseType="json";var n=REQ(e),s=n.then(function(e){return e.response},!0);return s.fn.push(t),s},t("Request.json",REQ.json)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/DB/Morgas.DB.js
(function(t,e,n){var s,r,i,a,o=n("shortcut")({debug:"debug",det:"Detached"}),l=t.DB=t.DB||{};s=l.Connector=t.Class({init:function(){o.det.detacheAll(this,["save","load","delete","destroy"])},save:function(){throw Error("abstract Class DB.Connector")},load:function(){throw Error("abstract Class DB.Connector")},"delete":function(){throw Error("abstract Class DB.Connector")},destroy:function(){throw Error("abstract Class DB.Connector")},saveChildren:function(t,e){return this.save(t.getChildren(e))},saveFriendships:function(t,e){var n=t.relations[e],r=t.friends[e];if(!r)return o.debug("no friends in relation "+e+" found",2),new o.det.complete(!1);var i=r[0].relations[n.targetRelationName],a=t.getID();if(null==a)return o.debug("friend id is null",2),new o.det.complete(!1);for(var l=[],h=0;r.length>h;h++){var c=r[h].getID();null!=c&&l.push(c)}if(0===l.length)return o.debug("no friend with friend id found"),new o.det.complete(!1);var f=s.getFriendTableName(t.objectType,e,r[0].objectType,n.targetRelationName),d=t.objectType+"_ID",p=r[0].objectType+"_ID",g=[];n.relatedClass===i.relatedClass&&(p+=2);for(var h=0;l.length>h;h++)g.push(new u(f,d,a,p,l[h]));return this.save(g)},loadParent:function(t,e){var n=t.relations[e],s=n.relatedClass,r=n.fieldName;return this.load(s,{ID:t.getValueOf(r)}).then(function(n){var s=n[0];s.addChild(e,t),this.complete(s)})},loadChildren:function(t,e,n){var s=t.relations[e],r=rel.relatedClass,i=s.fieldName;return n[i]=this.getID(),this.load(r,n).then(function(e){t.addChildren(e),this.complete(e)})},loadFriends:function(t,e,n){var r=this,i=t.relations[e],a=i.relatedClass,l=(new a).relations[i.targetRelationName],h=t.objectType+"_ID",c=a.prototype.objectType+"_ID",f=s.getFriendTableName(t.objectType,e,a.prototype.objectType,i.targetRelationName),d={};i.relatedClass===l.relatedClass&&(c+=2),d[h]=t.getID();var p=u.Generator(f,h,c),g=this.load(p,d);return i.relatedClass===l.relatedClass&&(g=g.then(function(t){var e=this;d[c]=d[h],delete d[h],r.load(p,d).then(function(n){for(var s=0;n.length>s;s++){var r=n[s].fields[h].value;n[s].fields[h].value=n[s].fields[c].value,n[s].fields[c].value=r}e.complete(t.concat(n))},o.debug)},o.debug)),g.then(function(t){return n.ID=t.map(function(t){return t.fields[c].value}),r.load(a,n)},o.debug)},deleteFriendships:function(t,e){var n=t.relations[e],r=t.friends[e];if(!r)return o.debug("no friends in relation "+e+" found",2),new o.det.complete(!1);var i=r[0].relations[n.targetRelationName],a=t.getID();if(null==a)return o.debug("friend id is null",2),new o.det.complete(!1);for(var l=[],h=0;r.length>h;h++){var c=r[h].getID();null!=c&&l.push(c)}if(0===l.length)return o.debug("no friend with friend id found"),new o.det.complete(!1);var f=s.getFriendTableName(t.objectType,e,r[0].objectType,n.targetRelationName),d=t.objectType+"_ID",p=r[0].objectType+"_ID",g=[];if(n.relatedClass===i.relatedClass){p+=2;var v={};v[d]=l,v[p]=a,g.push(v)}var v={};v[d]=a,v[p]=l,g.push(v);for(var y=[],m=u.Generator(f,d,p),h=0;g.length>h;h++)y.push(this["delete"](m,g[h]));return new o.det(y)}}),s.sortObjs=function(t){for(var e={friend:{},fresh:{},preserved:{}},n=0;t.length>n;n++){var s=t[n],r=s instanceof u?"friend":void 0===s.getID()?"fresh":"preserved",i=s.objectType;void 0===e[r][i]&&(e[r][i]=[]),e[r][i].push(s)}return e},s.getDeletePattern=function(t,e){var n=typeof e;if(("number"===n||e instanceof l.Object)&&(e=[e]),Array.isArray(e)){for(var s=0;e.length>s;s++)e[s]instanceof t&&(e[s]=e[s].getID());e={ID:e}}return e},s.getFriendTableName=function(t,e,n,s){return[t,e,n,s].sort().join("_")},e("DBConn",s),r=l.Object=t.Class({objectType:null,init:function(t){if(t=t||{},null==this.objectType)throw"DB.Object: objectType not defined";this.fields={},this.relations={},this.parents={},this.children={},this.friends={},this.addField("ID",a.TYPES.INT,t.ID,{UNIQUE:!0,AUTOGENERATE:!0})},addRelation:function(t,e,n,s,r){this.relations[t]=new i(e,n,s||t,r)},addField:function(t,e,n,s){this.fields[t]=new a(e,n,s)},getValueOf:function(t){return this.fields[t].getValue()},setValueOf:function(t,e){"ID"!=t&&this.fields[t].setValue(e)},setID:function(t){this.fields.ID.setValue(t);for(var e in this.children)for(var n=this.children[e],s=0;n.length>s;s++)n[s]._setParent(this.relations[e],this)},getID:function(){return this.getValueOf("ID")},getParent:function(t){return this.parents[t]},_setParent:function(t,e){var n=this.relations[t.targetRelationName];this.parents[t.targetRelationName]=e,this.setValueOf(n.fieldName,e.getValueOf(t.fieldName))},_add:function(t,e,n){var s=t[e]=t[e]||[];-1==s.indexOf(n)&&s.push(n)},_get:function(t,e){return(t[e]||[]).slice(0)},addChild:function(t,e){this.relations[t].type==i.TYPES.CHILD&&(this._add(this.children,t,e),e._setParent(this.relations[t],this))},addChildren:function(t,e){for(var n=0;e.length>n;n++)this.addChild(t,e[n])},getChildren:function(t){return this._get(this.children,t)},addFriend:function(t,e){this.relations[t].type==i.TYPES.FRIEND&&(this._add(this.friends,t,e),e._add(e.friends,this.relations[t].targetRelationName,this))},addFriends:function(t,e){for(var n=0;e.length>n;n++)this.addFriend(t,e[n])},getFriends:function(t){return this._get(this.friends,t)},toJSON:function(){var t={};for(var e in this.fields)t[e]=this.fields[e].toJSON();return t},fromJSON:function(t){for(var e in this.fields)void 0!==t[e]&&this.fields[e].fromJSON(t[e]);return this},toString:function(){return JSON.stringify(this)}}),e("DBObj",r);var u=l.Firendship=t.Class({init:function(t,e,n,s,r){this.objectType=t,this.fields={},this.fields[e]=new a(a.TYPES.INT,n),this.fields[s]=new a(a.TYPES.INT,r)},toJSON:r.prototype.toJSON,fromJSON:r.prototype.fromJSON});u.Generator=function(e,n,s){return t.Class(u,{objectType:e,init:function(){this.superInit(u,e,n,null,s,null)}})},e("DBFriend",u),i=l.Relation=t.Class({init:function(t,e,n,s){if(null==s){if(e==i.TYPES.PARENT)throw"DB.Relation: "+e+" relation needs a fieldName";s="ID"}this.type=e,this.relatedClass=t,this.fieldName=s,this.targetRelationName=n}}),i.TYPES={PARENT:-1,FRIEND:0,CHILD:1},e("DBRel",i),a=l.Field=t.Class({init:function(t,e,n){this.type=t,this.value=e,this.options=n||{}},setValue:function(t){this.value=t},getValue:function(){return this.value},toJSON:function(){switch(this.type){case a.TYPES.DATE:var t=this.getValue();if(t instanceof Date)return t.getUTCFullYear()+","+t.getUTCMonth()+","+t.getUTCDate()+","+t.getUTCHours()+","+t.getUTCMinutes()+","+t.getUTCSeconds()+","+t.getUTCMilliseconds();break;default:return this.getValue()}},fromJSON:function(t){switch(this.type){case a.TYPES.DATE:this.value=new Date(Date.UTC.apply(Date,t.split(",")));break;default:this.value=t}},toString:function(){return JSON.stringify(this)},fromString:function(t){switch(this.type){case a.TYPES.BOOL:this.value=!!~~t;break;case a.TYPES.INT:this.value=~~t;break;case a.TYPES.DOUBLE:this.value=1*t;break;case a.TYPES.DATE:this.fromJSON(JSON.parse(t));break;case a.TYPES.STRING:case a.TYPES.JSON:default:this.value=JSON.parse(t)}}}),a.TYPES={BOOL:0,INT:1,DOUBLE:2,STRING:3,DATE:4,JSON:5,BLOB:6},e("DBField",a)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/DB/Morgas.DB.IndexedDBConnector.js
(function(e,t,n){var r=n("DBConn"),s=n("shortcut")({det:"Detached",it:"iterate",eq:"equals",find:"find",DBObj:"DBObj",DBFriend:"DBFriend"}),i=r.IndexedDBConnector=e.Class(r,{init:function(e){this.superInit(r),this.name=e,s.det.detacheAll(this,["_open"])},save:function(t,n){n=[].concat(n);var r=i.sortObjs(n),o=Object.keys(r);this._open(o).then(function(n){var i=s.it(r,s.det.detache(function(t,r,i){var o=n.transaction(i,"readwrite");o.onerror=function(n){e.debug(n,0),t.complete(n)},o.oncomplete=function(n){e.debug(n,2),t.complete()};var a=o.objectStore(i);s.it(r,function(t){var n=t.toJSON(),r="put";void 0===n.ID&&(delete n.ID,r="add");var s=a[r](n);s.onerror=function(t){e.debug(t,0)},s.onsuccess=function(n){e.debug(n,3),t.setID&&t.setID(s.result)}})}),!1,!0);n.close(),t.complete(new s.det(i)),this.complete()},t.error)},load:function(t,n,r){this._open().then(function(i){if(i.objectStoreNames.contains(n.prototype.objectType)){var o=i.transaction(n.prototype.objectType,"readonly"),a=[];o.onerror=function(n){e.debug(n,0),i.close(),t.error(n)},o.oncomplete=function(){i.close(),t.complete(a)};var l=o.objectStore(n.prototype.objectType);if("number"==typeof r.ID||Array.isArray(r.ID))s.it([].concat(r.ID),function(t){var i=l.get(t);i.onerror=function(t){e.debug(t,0)},i.onsuccess=function(t){if(e.debug(t,3),s.eq(i.result,r)){var o=new n;o.fromJSON(i.result),a.push(o)}}});else{var u=l.openCursor();u.onerror=function(n){e.debug(n,0),i.close(),t.error(n)},u.onsuccess=function(){if(u.result){if(s.eq(u.result.value,r)){var e=new n;e.fromJSON(u.result.value),a.push(e)}u.result["continue"]()}}}}else i.close(),t.complete([]);this.complete()},t.error)},"delete":function(t,n,i){var o=this,a=n.prototype.objectType,l=null;if("number"==typeof i||i instanceof s.DBObj||i instanceof s.DBFriend||Array.isArray(i)){var u=r.getDeletePattern(n,i).ID;l=s.det.complete(u)}else l=this._open().then(function(n){var r=this,o=[],l=n.transaction(a,"readonly");l.onerror=function(s){e.debug(s,0),n.close(),t.error(s),r.error(s)},l.oncomplete=function(){n.close(),r.complete(o)};var u=l.objectStore(a),c=u.openCursor();c.onerror=function(s){e.debug(s,0),n.close(),t.error(s),r.error(s)},c.onsuccess=function(){c.result&&(s.eq(c.result.value,i)&&o.push(c.result.key),c.result["continue"]())}},t.error);l.then(function(r){return r.length>0?o._open().then(function(i){var o=i.transaction(n.prototype.objectType,"readwrite");o.onerror=function(n){e.debug(n,0),i.close(),t.error(n)};var l=o.objectStore(a),u=s.it(r,s.det.detache(function(t,n){var r=l["delete"](n);r.onerror=function(r){e.debug(r,0),t.complete(n)},r.onsuccess=function(n){e.debug(n,3),t.complete()}}));return new s.det(u).then(function(){i.close(),t.complete(Array.prototype.slice.call(arguments)),this.complete()},e.debug)}):(t.complete(!1),this.complete(),void 0)},function(e){db.close(),t.error(e,0),this.complete()})},destroy:function(){},_open:function(e,t){var n=this,r=indexedDB.open(this.name);r.onerror=function(t){e.error(t,0)},r.onsuccess=function(){for(var s=[],i=r.result,o=r.result.version,a=0;t&&t.length>a;a++)i.objectStoreNames.contains(t[a])||s.push(t[a]);if(0===s.length)e.complete(i);else{var l=indexedDB.open(n.name,o+1);l.onerror=function(t){e.error(t,0)},l.onupgradeneeded=function(){for(var e=0;s.length>e;e++)l.result.createObjectStore(s[e],{keyPath:"ID",autoIncrement:!0})},l.onsuccess=function(){n.version=l.result.version,e.complete(l.result)},i.close()}}}});i.sortObjs=function(e){for(var t={},n=0;e.length>n;n++){var r=e[n],s=r.objectType;void 0===t[s]&&(t[s]=[]),t[s].push(r)}return t},t("IndexedDBConnector",i),t("IDBConn",i)})(Morgas,Morgas.setModule,Morgas.getModule);
//GUI/TalePlay.GUIElement.js
(function(t,e,i){var s=window.TalePlay=window.TalePlay||{},n=i("Listeners"),o=i("shortcut")({sc:"shortcut",node:"NodePatch",Layer:"Layer"}),a=s.GUIElement=t.Class(n,{init:function(t){t=t||{},this.superInit(n),this.nodePatch=new o.node(this,{parent:"parent",children:"children",addChild:"addChild",removeChild:"removeChild"},!0),o.sc({layer:function(t){for(var e=t.parent;e&&!(e instanceof o.Layer);)e=e.parent;return e}},this,this.nodePatch,!0),this.domElement=document.createElement(t.element||"div"),this.addStyleClass("GUIElement"),t.styleClass&&this.addStyleClass(t.styleClass)},addStyleClass:function(t){var e=this.domElement.classList;Array.isArray(t)?e.add.apply(e,t):e.add(t)},removeStyleClass:function(t){var e=this.domElement.classList;Array.isArray(t)?e.remove.apply(e,t):e.remove(t)},addChild:function(t,e){return t instanceof a&&this.nodePatch.addChild(t)?("string"==typeof e&&(e=this.domElement.querySelector(e)),e||(e=this.domElement),e.appendChild(t.domElement),!0):!1},removeChild:function(t){return this.nodePatch.removeChild(t)?(t.domElement.remove(),t.removeListener("all",this),!0):!1},onAnalogStick:function(){},onButton:function(){},destroy:function(){this.nodePatch.remove();for(var t=this.children.slice(),e=0;t.length>e;e++)t[e].destroy();n.prototype.destroy.call(this)}});e("GUIElement",a)})(Morgas,Morgas.setModule,Morgas.getModule);
//TalePlay.Map.js
(function(t,e,i){var n=window.TalePlay=window.TalePlay||{},s=i("shortcut")({find:"find",Node:"NodePatch",point:"Math.Point",RECT:"Math.Rect"}),o=n.Map=t.Class({init:function(t){this.nodePatch=new s.Node(this,{children:"images",addChild:"add",removeChild:"remove"}),t=t||{},this.position=new s.point,this.size=new s.point(t.size),this.domElement=t.domElement||document.createElement("div"),this.domElement.classList.add("Map"),this.stage=document.createElement("div"),this.stage.classList.add("stage"),this.domElement.appendChild(this.stage),t.images&&this.addAll(t.images),this.size.equals(0)&&this.calcSize(),this.setPosition(t.position)},addAll:function(t){t=[].concat(t);for(var e=0;t.length>e;e++)this.add(t[e])},add:function(t){return this.nodePatch.addChild(t)?(this.stage.appendChild(t.domElement),t.update(),!0):!1},remove:function(t){return this.nodePatch.removeChild(t)?(this.stage.removeChild(t.domElement),!0):!1},setPosition:function(t,e){this.position.set(t,e),this.position.doMath(Math.max,0).doMath(Math.min,this.getSize()),this.update(!0)},getPosition:function(){return this.position},move:function(t,e){this.position.add(t,e),this.position.doMath(Math.max,0).doMath(Math.min,this.getSize()),this.update(!0)},update:function(t){var e=this.position.clone(),i=this.domElement.getBoundingClientRect();e.sub(i.width/2,i.height/2),this.stage.style.top=-e.y+"px",this.stage.style.left=-e.x+"px";for(var n=0;!t&&this.images.length>n;n++)this.images[n].update()},getImages:function(t){return s.find(this.images,t,!0)},getSize:function(){return this.size},setSize:function(t,e){this.size.set(t,e)},calcSize:function(t){this.size.set(0);for(var e=0;this.images.length>e;e++)(!t||t(this.images[e]))&&this.size.doMath(Math.max,this.images[e].rect.position.clone().add(this.images[e].rect.size))},empty:function(){for(;this.images.length>0;)this.remove(this.images[0])},toJSON:function(){return{images:this.images.slice(),position:this.position.clone(),size:this.size.clone()}},fromJSON:function(t){this.empty();for(var e=0;t.images.length>e;e++){var i=t.images[e];i instanceof o.Image||(i=(new o.Image).fromJSON(i)),this.add(i)}return this.size.set(t.size),this.size.equals(0)&&this.calcSize(),this.setPosition(t.position),this}});o.Image=t.Class({init:function(t,e,i,n){new s.Node(this,{parent:"map",remove:"remove"}),this.rect=new s.RECT(e,i),this.domElement=document.createElement("img"),Object.defineProperty(this,"url",{enumerable:!0,get:function(){return this.domElement.src},set:function(t){this.domElement.src=t}}),this.url=t,Object.defineProperty(this,"name",{enumerable:!0,get:function(){return this.domElement.dataset.name},set:function(t){this.domElement.dataset.name=t}}),this.name=n||""},update:function(){this.domElement.style.top=this.rect.position.y+"px",this.domElement.style.left=this.rect.position.x+"px",this.domElement.style.height=this.rect.size.y+"px",this.domElement.style.width=this.rect.size.x+"px"},getPosition:function(){return this.rect.position.clone()},setPosition:function(t,e){this.move(this.getPosition().negate().add(t,e)),this.update()},move:function(t,e){this.rect.position.add(t,e),this.update()},toJSON:function(){return{url:this.url,position:this.rect.position,size:this.rect.size,name:this.name}},fromJSON:function(t){return this.url=t.url,this.rect.setPosition(t.position),this.rect.setSize(t.size),this.name=t.name,this.update(),this}}),e("Map",o)})(Morgas,Morgas.setModule,Morgas.getModule);
//GUI/TalePlay.GUIElement.Map.js
(function(t,e,i){var s=i("GUIElement"),n=i("Map"),o=i("shortcut")({find:"find",rescope:"rescope",proxy:"proxy",Org:"Organizer",point:"Math.Point"}),a=function(t){return t instanceof s.Map.Cursor},r=function(t){return t.organizer.getFilter("cursors")};s.Map=t.Class(s,{init:function(t){t=t||{},this.superInit(s,t),this.createListener("trigger"),o.rescope.all(["_animateCursor"],this),this.map=new n({domElement:this.domElement,images:t.images,position:t.position}),this.map.gui=this,o.proxy("map",["setPosition","move","getImages","getSize","update"],this),this.organizer=(new o.Org).filter("cursors",a).filter("collision","collision").group("trigger","trigger.type"),this.threshold=new o.point,i("shortcut")({cursors:r},this,this,!0),this.movingCursors=new Map,this.setThreshold(t.threshold),t.cursors&&this.addAll(t.cursors),this.assignFilter=t.assignFilter||null,this.animationRquest=null,this.paused=t.paused===!0},addAll:function(t){t=[].concat(t);for(var e=0;t.length>e;e++)this.add(t[e])},add:function(t){this.map.add(t)&&this.organizer.add([t])},remove:function(t){this.map.remove(t)&&(this.organizer.remove(t),this.movingCursors["delete"](t))},getCursors:function(t){return o.find(this.cursors,t,!0)},updateSize:function(){this.map.calcSize(function(t){return!(t instanceof s.Map.Cursor)})},setThreshold:function(t,e){this.threshold.set(t,e)},setPaused:function(t){if(this.paused=!!t,null!==this.animationRquest&&this.paused)cancelAnimationFrame(this.animationRquest),this.animationRquest=null;else if(!this.paused){for(var e=Date.now(),i=this.movingCursors.entries(),s=null;s=i.next(),!s.done;){s.value[0];var n=s.value[1];n.lastTime=e-performance.timing.navigationStart}this.animationRquest=requestAnimationFrame(this._animateCursor)}},isPaused:function(){return this.paused},collide:function(t){for(var e=[],i=this.organizer.getFilter("collision"),s=0;i.length>s;s++)i[s].rect.collide(t)&&e.push(i[s]);return e},trigger:function(t,e,i){for(var s=[],n=this.organizer.getGroupValue("trigger",t),o=0;n.length>o;o++)n[o].rect.contains(e,i)&&s.push(n[o]);return s},onAnalogStick:function(t){for(var e=0;this.cursors.length>e;e++)if(!this.assignFilter||this.assignFilter(t,this.cursors[e],e)){var i=this.movingCursors.get(this.cursors[e]);i||(i={direction:null,lastTime:Date.now()-performance.timing.navigationStart},this.movingCursors.set(this.cursors[e],i),i.lastTime=Date.now()-performance.timing.navigationStart),i.direction=t.analogStick.clone()}null!==this.animationRquest||this.paused||(this.animationRquest=requestAnimationFrame(this._animateCursor))},_animateCursor:function(t){for(var e=this.movingCursors.entries(),i=null;i=e.next(),!i.done;){var n=i.value[0],o=i.value[1];if(!o.direction.equals(0)&&n){var a=Math.min(t-o.lastTime,s.Map.MAX_TIME_DELAY);n.domElement.classList.add("moving");for(var r=n.move(o.direction,a),l=this.trigger("step",n.getPosition()),h=0;l.length>h;h++)this.fire("trigger",{triggerType:"step",image:l[h],cursor:n,value:l[h].trigger.value,distance:r});o.lastTime=t;var d=n.getPosition(),c=this.map.getPosition();c.x-this.threshold.x>d.x?this.move(d.x-c.x+this.threshold.x,0):d.x>c.x+this.threshold.x&&this.move(d.x-c.x-this.threshold.x,0),c.y-this.threshold.y>d.y?this.move(0,d.y-c.y+this.threshold.y):d.y>c.y+this.threshold.y&&this.move(0,d.y-c.y-this.threshold.y)}else n.domElement.classList.remove("moving"),this.movingCursors["delete"](n)}this.animationRquest=this.movingCursors.size>0&&!this.paused?requestAnimationFrame(this._animateCursor):null},onButton:function(t){if(1===t.value&&!this.paused)for(var e=0;this.cursors.length>e;e++){var i=this.cursors[e];if(!this.assignFilter||this.assignFilter(t,i,e)){var s=this.trigger("activate",i.getPosition());if(0===s.length&&i.direction){var n=i.direction,a=new o.point(i.rect.position.x+(0===n.x?i.offset.x:n.x>0?i.rect.size.x:0),i.rect.position.y+(0===n.y?i.offset.y:0>n.y?i.rect.size.y:0));s=this.trigger("activate",a)}for(var r=0;s.length>r;r++)"activate"===s[r].trigger.type&&this.fire("trigger",{triggerType:"activate",image:s[r],cursor:this.cursors[e],value:s[r].trigger.value,controllerEvent:t})}}},toJSON:function(){var t=this.map.toJSON();t.cursors=this.cursors.slice(),t.threshold=this.threshold.clone;for(var e=0;this.cursors.length>e;e++)t.map.images.splice(t.map.images.indexOf(this.cursors[e]),1);return t},fromJSON:function(t){this.movingCursors.clear();for(var e=0;t.images.length>e;e++)t.images[e]=(new s.Map.Image).fromJSON(t.images[e]);for(var e=0;t.cursors.length>e;e++)t.images.push((new s.Map.Cursor).fromJSON(t.cursors[e]));this.map.fromJSON(t),this.organizer.clear().add(t.images),this.threshold.set(t.threshold)}}),s.Map.MAX_TIME_DELAY=250,s.Map.Image=t.Class(n.Image,{init:function(t,e,i,s,o,a){this.superInit(n.Image,t,e,i,s),this.collision=!!o,this.trigger={type:null,value:null},a&&(this.trigger.type=a.type||null,this.trigger.value=a.value||null)},toJSON:function(){var t=n.Image.prototype.toJSON.call(this);return t.collision=this.collision,t.trigger=this.trigger,t},fromJSON:function(t){return n.Image.prototype.fromJSON.call(this,t),this.collision=t.collision,this.trigger=t.trigger,this}}),s.Map.Cursor=t.Class(s.Map.Image,{init:function(t,e,i,n,a,r,l,h){this.superInit(s.Map.Image,s.Map.Cursor.emptyImage,e,i,a,r,l),this.domElement.classList.add("cursor"),this.domElement.style.zIndex=s.Map.Cursor.zIndexOffset,Object.defineProperty(this,"backUrl",{enumerable:!0,get:function(){return this.domElement.style.backgroundImage},set:function(t){this.domElement.style.backgroundImage='url("'+t+'")'}}),this.urls=null,this.setUrls(t),this.offset=new o.point(this.rect.size).div(2),this.setOffset(n),this.speed=new o.point(200),this.setSpeed(h),this.direction=null,this.updateDirection()},update:function(){s.Map.Image.prototype.update.call(this)},updateDirection:function(){if(this.domElement.classList.remove("up","right","down","left"),this.direction){var t=this.direction.getDirection8();this.backUrl=this.urls[t]?this.urls[t]:0!==t&&0===t%2&&this.urls[t-1]?this.urls[t-1]:this.urls[0],t>=1&&(2>=t||8===t)&&this.domElement.classList.add("up"),t>=2&&4>=t&&this.domElement.classList.add("right"),t>=4&&6>=t&&this.domElement.classList.add("down"),t>=6&&8>=t&&this.domElement.classList.add("left")}},setOffset:function(t,e){this.rect.position.add(this.offset),this.offset.set(t,e),this.rect.position.sub(this.offset),this.update()},setPosition:function(t,e){this.rect.position.set(t,e).sub(this.offset),this.update()},getPosition:function(){return this.rect.position.clone().add(this.offset)},setSpeed:function(t,e){this.speed.set(t,e)},setUrls:function(t){this.urls=[].concat(t),this.backUrl=this.urls[0],this.domElement&&this.updateDirection()},move:function(t,e){this.direction=t;var i=new o.point;if(this.map){var n=this.map.getSize();i.set(this.direction).mul(this.speed).mul(e/1e3).mul(1,-1);var a=this.rect.position.clone().add(this.offset);if(0>a.x+i.x?i.x=-a.x:a.x+i.x>n.x&&(i.x=n.x-a.x),0>a.y+i.y?i.y=-a.y:a.y+i.y>n.y&&(i.y=n.y-a.y),this.collision){var r=1,l=this.rect.clone();l.position.add(i);for(var h=this.map.gui.collide(l),d=0;h.length>d;d++){var c=h[d],u=null;c===this||this.rect.contains(c.rect)||c.rect.contains(this.rect)||(i.x>0&&c.rect.position.x>=this.rect.position.x+this.rect.size.x?u=Math.max(u,(c.rect.position.x-this.rect.position.x-this.rect.size.x)/i.x):0>i.x&&this.rect.position.x>=c.rect.position.x+c.rect.size.x&&(u=Math.max(u,(c.rect.position.x+c.rect.size.x-this.rect.position.x)/i.x)),i.y>0&&c.rect.position.y>=this.rect.position.y+this.rect.size.y?u=Math.max(u,(c.rect.position.y-this.rect.position.y-this.rect.size.y)/i.y):0>i.y&&this.rect.position.y>=c.rect.position.y+c.rect.size.y&&(u=Math.max(u,(c.rect.position.y+c.rect.size.y-this.rect.position.y)/i.y)),null!==u&&(r=Math.min(r,u)))}i.mul(r)}s.Map.Image.prototype.move.call(this,i)}return this.updateDirection(),i},toJSON:function(){var t=s.Map.Image.prototype.toJSON.call(this);return t.offset=this.offset,t.speed=this.speed,delete t.url,t.urls=this.urls.slice(),t},fromJSON:function(t){return t.url=s.Map.Cursor.emptyImage,s.Map.Image.prototype.fromJSON.call(this,t),this.offset.set(t.offset),this.speed.set(t.speed),this.setUrls(t.urls),this}}),s.Map.Cursor.emptyImage="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",s.Map.Cursor.zIndexOffset=100,e("GUI.Map",s.Map)})(Morgas,Morgas.setModule,Morgas.getModule);
//RPGPlayer/TalePlay.GUIElement.Dialog.js
(function(t,e,i){var s=i("GUIElement"),n=i("shortcut")({proxy:"proxy",tb:"GUI.TextBox",menu:"GUI.Menu"}),o=s.Dialog=t.Class(s,{init:function(t){t=t||{},t.element="fieldset",this.superInit(s,t),this.createListener("dialogEnd"),this.legend=document.createElement("legend"),this.domElement.appendChild(this.legend),this.dialogParts=t.dialogParts?t.dialogParts.slice():[],this.actions=t.actions||[],this.active=null,n.proxy("active",["onAnalogStick","onButton"],this),this.next()},next:function(t){if(this.active&&(this.active.destroy(),this.active.domElement.remove()),this.dialogParts.length>0){for(var e=this.dialogParts.shift(),i=["width","height","top","right","bottom","left"],s=0;i.length>s;s++)this.domElement.style[i[s]]=e[i[s]]||"";e.parts?(this.legend.textContent=e.title,this.active=new n.tb({parts:e.parts}),this.active.addListener("complete:once",this,"next"),this.active.start()):e.choices&&(this.active=new n.menu({items:e.choices,converter:o.MENU_CONVERTER,loop:!1,active:0,selectionType:n.menu.SelectionTypes.NONE}),this.active.addListener("select:once",this,"next")),this.domElement.appendChild(this.active.domElement)}else{var a;a=t&&"select"===t.type&&t.value.actions?this.actions.concat(t.value.actions):this.actions,this.fire("dialogEnd",{actions:a})}}});o.MENU_CONVERTER=function(t){return t.name},e("GUI.Dialog",o)})(Morgas,Morgas.setModule,Morgas.getModule);
//RPGPlayer/TalePlay.RPGPlayer.GameSave.js
(function(t,e,i){var s=i("RPGPlayer"),n=i("DBObj"),o=i("shortcut")({field:"DBField"}),a=s.GameSave=t.Class(n,{objectType:"GameSave",init:function(t){t=t||{},this.superInit(n,t),this.addField("map",o.field.TYPES.String,t.map),this.addField("position",o.field.TYPES.JSON,t.position),this.addField("cursor",o.field.TYPES.JSON,t.cursor),this.addField("quests",o.field.TYPES.JSON,t.quests),this.addField("actions",o.field.TYPES.JSON,t.actions),this.addField("info",o.field.TYPES.String,t.info),this.addField("timeStamp",o.field.TYPES.DATE,t.timeStamp||new Date)},getMap:function(){return this.getValueOf("map")},getPosition:function(){return this.getValueOf("position")},getCursor:function(){return this.getValueOf("cursor")},getQuests:function(){return this.getValueOf("quests")},getActions:function(){return this.getValueOf("actions")},getInfo:function(){return this.getValueOf("info")},getTimeStamp:function(){return this.getValueOf("timeStamp")}});e("RPGPlayer.GameSave",a)})(Morgas,Morgas.setModule,Morgas.getModule,Morgas.hasModule);
//TalePlay.Layer.ActionMenu.js
(function(t,e,i){var s=i("Layer"),n=i("shortcut")({Menu:"GUI.Menu",debug:"debug"}),o=s.ActionMenu=t.Class(s,{init:function(t){t=t||{},this.superInit(s,{mode:s.Modes.LAST}),this.domElement.classList.add("ActionMenu"),this.menu=new n.Menu({styleClass:t.styleClass,items:t.actions,active:t.active||0,loop:t.loop===!0,selectionType:n.Menu.SelectionTypes.NONE,converter:t.converter||o.defaultConverter,disabled:t.disabled}),this.add(this.menu),this.menu.addListener("select",this,"_onSelect")},_onSelect:function(t){"function"==typeof this[t.value.action]?this[t.value.action](t.value):n.debug(t.value.action+" is not a function",n.debug.LEVEL.ERROR)}});o.defaultConverter=function(t){return t.text},e("Layer.ActionMenu",o)})(Morgas,Morgas.setModule,Morgas.getModule);
//TalePlay.Layer.ActionMenu.StartMenu.js
(function(t,e,i){var s=i("Layer.ActionMenu"),n=i("shortcut")({manager:"GUI.ControllerManager",rj:"Request.json",debug:"debug"}),o=s.StartMenu=t.Class(s,{init:function(t){t=t||{},this.superInit(s,{styleClass:["panel","center"],actions:[{text:"New Game",action:"newGame",url:t.newGameUrl},{text:"Controllers",action:"openControllerManager",controllerLayout:t.controllerLayout||{}},{text:"Load",action:"loadSave"},{text:"import from File",action:"fileImport"}]}),this.domElement.classList.add("StartMenu"),this.createListener("start"),this.persistanceLayer="function"==typeof t.persistanceLayer?t.persistanceLayer:i(t.persistanceLayer||"Layer.Persistance"),this.dbConn=t.dbConn,this.saveClass=t.saveClass,this.saveConverter=t.saveConverter},onController:function(t){if("buttonChanged"===t.type&&1==t.value)switch(t.index){case 1:this.menu.setActive(0);break;case 2:s.prototype.onController.call(this,t)}else s.prototype.onController.call(this,t)},newGame:function(t){n.rj(t.url,this).then(function(t,e){var i=new e.saveClass;i.fromJSON(t),e.fire("start",{save:i})},function(t){n.debug(["could not load new game: ",t],n.debug.LEVEL.ERROR)})},openControllerManager:function(t){var e={styleClass:["panel","overlay"],buttons:t.controllerLayout.buttons,analogSticks:t.controllerLayout.analogSticks,dbConn:this.dbConn},i=new n.manager(e);this.add(i),i.update("controllers")},loadSave:function(){var t=new this.persistanceLayer({dbConn:this.dbConn,saveClass:this.saveClass,saveConverter:this.saveConverter});t.addListener("load:once",this,function(t){this.fire("start",{save:t.save}),t.source.destroy()}),this.board.addLayer(t)},fileImport:function(){}});e("StartMenu",o)})(Morgas,Morgas.setModule,Morgas.getModule);
//RPGPlayer/TalePlay.Layer.ActionMenu.GameMenu.js
(function(t,e,i){var s=i("Layer.ActionMenu"),n=s.GameMenu=t.Class(s,{init:function(t){t=t||{};var e={styleClass:["panel"],actions:[{text:"save",action:"saveGame",data:t.saveData},{text:"close",action:"close"}]};t.saveData||(e.disabled=[0]),this.superInit(s,e),this.domElement.classList.add("GameMenu"),this.createListener("start close"),this.persistanceLayer="function"==typeof t.persistanceLayer?t.persistanceLayer:i(t.persistanceLayer||"Layer.Persistance"),this.dbConn=t.dbConn,this.saveClass=t.saveClass,this.saveConverter=t.saveConverter},onController:function(t){if("buttonChanged"===t.type&&1==t.value)switch(t.index){case 1:this.menu.setActive(1);break;case 2:s.prototype.onController.call(this,t)}else s.prototype.onController.call(this,t)},saveGame:function(t){if(t.data){var e=new this.persistanceLayer({dbConn:this.dbConn,saveClass:this.saveClass,saveConverter:this.saveConverter,saveData:t.data});this.board.addLayer(e)}},close:function(){this.fire("close")}});e("RPGPlayer.GameMenu",n)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.Patch.js
(function(t,e){var n=function(t){return void 0!==this.getPatch(t)},o=function(t){return this.patches[t.patchID||t.prototype.patchID]},c=function(){this.patch(this._patchParam,!1),delete this._patchParam},s=t.Patch=t.Class({init:function(t,e,s){null==t.patches&&(t.patches={},t.hasPatch=n,t.getPatch=o),t.hasPatch(this)||(this.instance=t,t.patches[this.patchID]=this,"function"==typeof this.instance.addListener?(this._patchParam=e,this.instance.addListener(".created:once",this,c),s&&this.patchNow()):this.patch(e,!0))},patchNow:function(){this.instance.patches[this.patchID]===this&&"function"==typeof this.instance.removeListener&&this.instance.removeListener(".created",this)&&this.patch(this._patchParam,!1)},patch:function(){},superPatch:function(t){t.prototype.patch.apply(this,[].slice.call(arguments,1))},superPatchApply:function(t,e){this.superPatch.apply(this,[t].concat([].slice.call(e)))}});e("Patch",s),s.hasPatch=function(t,e){return t.hasPatch?t.hasPatch(e):!1},s.getPatch=function(t,e){return t&&t.getPatch?t.getPatch(e):null}})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.NodePatch.js
(function(e,t,s){var n=s("Patch"),i=s("shortcut")({p:"proxy",d:"debug"}),r=e.NodePatch=e.Class(n,{patchID:"NodePatch",patch:function(e){this.parent=null,this.children=[],e=e||{},this.aliasMap={};for(var t={},s=0;r.Aliases.length>s;s++){var n=r.Aliases[s];n in e&&(this.aliasMap[n]=e[n],void 0===this.instance[this.aliasMap[n]]&&(t[n]=this.aliasMap[n]))}i.p(a,t,this.instance);for(var s=0;r.Symbols.length>s;s++){var l=r.Symbols[s];l in e&&o(this,l,e[l])}},addChild:function(e,t){var s,n=a(e),r=this.children.indexOf(e);if(!n)return i.d([e," is not a Node"]),!1;if(-1===r){if(void 0!==t?this.children.splice(t,0,e):(t=this.children.length,this.children.push(e)),null!==n.parent&&n.parent!==this.instance)if(s=n.aliasMap.remove){if(!e[s]())return i.d(["rejected remove child ",e," from old parent ",n.parent],i.d.LEVEL.INFO),this.children.splice(t,1),!1}else n.remove();if(s=n.aliasMap.setParent){if(!e[s](this.instance))return i.d(["rejected to set parent",this.instance," of child ",e],i.d.LEVEL.INFO),this.children.splice(t,1),!1}else n.setParent(this.instance)}return!0},removeChild:function(e){var t=this.children.indexOf(e);if(-1!==t){this.children.splice(t,1);var s=a(e);if(s&&s.parent===this.instance){var n=s.aliasMap.remove;if(n){if(!e[n]())return i.d(["rejected remove child ",e," from parent ",this.instance],i.d.LEVEL.INFO),this.children.splice(t,0,e),!1}else s.remove()}}return!0},setParent:function(e){var t,s=a(e);if(!s)return i.d([e," is not a Node"]),!1;if(e&&this.parent!==e){if(null!==this.parent)if(t=childPatch.aliasMap.remove){if(!child[t]())return i.d(["rejected remove child ",child," from old parent ",childPatch.parent],i.d.LEVEL.INFO),this.children.splice(index,1),!1}else childPatch.remove();if(this.parent=e,t=s.aliasMap.addChild,-1===s.children.indexOf(this.instance))if(t){if(!this.parent[t](this.instance))return i.d(["rejected to add child ",this.instance," to parent ",e],i.d.LEVEL.INFO),this.parent=null,!1}else s.addChild(this.instance)}return!0},remove:function(){if(null!==this.parent){var e=this.parent,t=a(e);if(this.parent=null,-1!==t.children.indexOf(this.instance)){var s=t.aliasMap.removeChild;if(s){if(!e[s](this.instance))return this.parent=e,i.d(["rejected to remove child ",this.instance," from parent ",this.parent],i.d.LEVEL.INFO),!1}else t.removeChild(this.instance)}}return!0},hasChild:function(e){return-1!==this.children.indexOf(e)},isChildOf:function(e){return a(e),e&&e.hasChild(this.instance)}});r.Aliases=["addChild","removeChild","remove","setParent","hasChild"],r.Symbols=["parent","children"],r.BasicAliases={parent:"parent",children:"children",addChild:"addChild",removeChild:"removeChild",remove:"remove",setParent:"setParent",hasChild:"hasChild"},r.Basic=e.Class({init:function(e){e=e||{};for(var t={},s=0,n=Object.keys(r.BasicAliases);n.length>s;s++){var i=n[s],a=e[i];void 0===a&&(a=r.BasicAliases[i]),null!==a&&(t[i]=""+a)}new r(this,t)}});var a=function(e){return"string"==typeof e&&(e=this),e instanceof r?e:n.getPatch(e,r)},o=function(e,t,s){"function"!=typeof e[t]?Object.defineProperty(e.instance,s,{get:function(){return e[t]},set:function(s){e[t]=s}}):e.instance[s]=e[t]};t("NodePatch",r)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.util.object.equals.js
(function(e,t){var n=e.util=e.util||{},s=n.object||{};s.equals=function(e,t){if(e===t)return!0;if(void 0===e||null===e)return!1;if(t instanceof RegExp)return t.test(e);if("function"==typeof t)return"function"==typeof e?!1:t(e);if("function"==typeof e.equals)return e.equals(t);if("object"==typeof t){if("object"!=typeof e&&Array.isArray(t))return-1!==t.indexOf(e);for(var n in t)if(!s.equals(e[n],t[n]))return!1;return!0}return!1},t("equals",s.equals)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.util.object.find.js
(function(e,t,n){var s=e.util=e.util||{},i=s.object||{},r=n("shortcut")({eq:"equals",it:"iterate"});i.find=function(e,t,n){var s=[];return r.it(e,function(e,i){r.eq(e,t)&&s.push(n?e:{value:e,index:i})}),s},t("find",i.find)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.util.object.iterate.js
(function(µ,SMOD,GMOD){

	var util=µ.util=µ.util||{};
	var obj=util.object||{};
	
	/** createIterator
	 * Creates an iterator for {any} in {backward} order.
	 * {isObject} declares {any} as a Map or Array. 
	 */
	//TODO iterator & Set & Map
	obj.createIterator=function* (any,backward,isObject)
	{
		if(any.length>=0&&!isObject)
		{
			for(var i=(backward?any.length-1:0);i>=0&&i<any.length;i+=(backward?-1:1))
			{
				yield [any[i],i];
			}
		}
		else if (typeof any.next==="function"||typeof any.entries==="function")
		{
			if(typeof any.entries==="function")
			{
				any=any.entries();
			}
			var step=null;
			while(step=any.next(),!step.done)
			{
				yield step.value.reverse();
			}
		}
		else
		{
			var k=Object.keys(any);
			if(backward)
			{
				k.revert();
			}
			for(var i=0;i<k.length;i++)
			{
				yield [any[k[i]],k[i]];
			}
		}
		
	};
	/** iterate
	 * Iterates over {any} calling {func} with {scope} in {backward} order.
	 * {isObject} declares {any} as an Object with a length property.
	 * 
	 * returns Array of {func} results
	 */
	//TODO iterator & Set & Map
	obj.iterate=function(any,func,backward,isObject,scope)
	{
		var rtn=[];
		if(!scope)
		{
			scope=window;
		}
		if(any.length>=0&&!isObject)
		{
			for(var i=(backward?any.length-1:0);i>=0&&i<any.length;i+=(backward?-1:1))
			{
				rtn.push(func.call(scope,any[i],i,i,false));
			}
		}
		else if (typeof any.next==="function"||typeof any.entries==="function")
		{
			if(typeof any.entries==="function")
			{
				any=any.entries();
			}
			var step=null,index=0;
			while(step=any.next(),!step.done)
			{
                isObject=step.value[1]!==step.value[0]&&step.value[0]!==index;
				rtn.push(func.call(scope,step.value[1],step.value[0],index,isObject));
                index++;
			}
		}
		else
		{
			var k=Object.keys(any);
			if(backward)
			{
				k.revert();
			}
			for(var i=0;i<k.length;i++)
			{
				rtn.push(func.call(scope,any[k[i]],k[i],i,true));
			}
		}
		return rtn;
	};
	SMOD("Iterator",obj.createIterator);
	SMOD("iterate",obj.iterate);
	
})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.util.function.rescope.js
(function(t,e){var s=t.util=t.util||{},n=s.function||{};n.rescope=function(t,e){return function(){return t.apply(e,arguments)}},n.rescope.all=function(t,e){t=t||Object.keys(e);for(var s=0;t.length>s;s++)e[t[s]]=n.rescope(e[t[s]],e)},e("rescope",n.rescope)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.util.function.proxy.js
(function(t,e,s){var n=t.util=t.util||{},i=n["function"]||{},r=s("shortcut")({it:"iterate"});i.proxy=function(t,e,s){var n=!1,i=!1;switch(typeof t){case"string":n=!0;break;case"function":i=!0}r.it(e,function(e,r,a,o){var l=o?r:e,u=e,c=null;c=n?function(){return this[t][l].apply(this[t],arguments)}:i?function(){var e=t.call(this,l);return e[l].apply(e,arguments)}:function(){return t[l].apply(t,arguments)},s[u]=c})},e("proxy",i.proxy)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas/src/Morgas.Organizer.js
(function(t,e,s){var n=s("shortcut")({it:"iterate",eq:"equals",path:"goPath"}),i=t.Organizer=t.Class({init:function(t){this.values=[],this.filters={},this.maps={},this.groups={},t&&this.add(t)},add:function(t,e,s){return e&&s&&(this.group(e),this.groups[e].values[s]=[]),n.it(t,function(t){var n=this.values.length;this.values.push(t);for(var i in this.maps)this._map(this.maps[i],n);for(var r in this.filters)this._filter(this.filters[r],n);for(var a in this.groups)this._group(this.groups[a],n);e&&s&&this.groups[e].values[s].push(n)},!1,!1,this),this},remove:function(t){var e=this.values.indexOf(t);if(-1!==e){for(var s in this.filters){var n=this.filters[s].values.indexOf(e);-1!==n&&this.filters[s].values.splice(n,1)}for(var s in this.maps)for(var i=this.maps[s].values,r=Object.keys(i),s=0;r.length>s;s++)if(i[r[s]]===t){delete i[r[s]];break}for(var s in this.groups)for(var a=this.groups[s].values,r=Object.keys(a),s=0;r.length>s;s++){var n=a[r[s]].indexOf(e);if(-1!==n){a[r[s]].splice(n,1);break}}delete this.values[e]}return this},_removeType:function(t,e){delete this[t][e]},clear:function(){for(var t in this.filters)this.filters[t].values.length=0;for(var t in this.maps)this.maps[t].values={};for(var t in this.groups)this.groups[t].values={};return this.values.length=0,this},map:function(t,e){"string"==typeof e&&(e=i._pathWrapper(e)),this.maps[t]={fn:e,values:{}};for(var s=0;this.values.length>s;s++)this._map(this.maps[t],s);return this},_map:function(t,e){var s=""+t.fn(this.values[e]);t.values[s]=e},getMap:function(t){var e={};return null!=this.maps[t]&&n.it(this.maps[t].values,function(t,s){e[s]=this.values[t]},!1,!0,this),e},hasMap:function(t){return!!this.maps[t]},hasMapKey:function(t,e){return this.maps[t]&&e in this.maps[t].values},getMapValue:function(t,e){return this.hasMapKey(t,e)?this.values[this.maps[t].values[e]]:void 0},getMapKeys:function(t){return this.hasMap(t)?Object.keys(this.maps[t].values):[]},removeMap:function(t){return this._removeType("maps",t),this},filter:function(t,e,s){switch(typeof e){case"string":e=i._pathWrapper(e);break;case"object":e=i.filterPattern(e)}"string"==typeof s&&(s=i.pathSort(s)),this.filters[t]={filterFn:e,sortFn:s,values:[]};for(var n=0;this.values.length>n;n++)this._filter(this.filters[t],n);return this},_filter:function(t,e){if(!t.filterFn||t.filterFn(this.values[e]))if(t.sortFn){var s=i.getOrderIndex(this.values[e],this.values,t.sortFn,t.values);t.values.splice(s,0,e)}else t.values.push(e)},hasFilter:function(t){return!!this.filters[t]},getFilter:function(t){var e=[];return null!=this.filters[t]&&n.it(this.filters[t].values,function(t,s){e[s]=this.values[t]},!1,!1,this),e},getFilterValue:function(t,e){return this.filters[t]&&this.filters[t].values[e]?this.values[this.filters[t].values[e]]:void 0},getFilterLength:function(t){return this.filters[t]?this.filters[t].values.length:0},removeFilter:function(t){return this._removeType("filters",t),this},group:function(t,e){if("string"==typeof e&&(e=i._pathWrapper(e)),this.groups[t]={values:{},fn:e},e)for(var s=0;this.values.length>s;s++)this._group(this.groups[t],s);return this},_group:function(t,e){if(t.fn){var s=t.fn(this.values[e]);t.values[s]=t.values[s]||[],t.values[s].push(e)}},hasGroup:function(t){return!!this.groups[t]},getGroup:function(t){var e={};if(this.hasGroup(t))for(var s in this.groups[t].values)e[s]=this.getGroupValue(t,s);return e},getGroupValue:function(t,e){var s=[];if(this.hasGroup(t)&&this.groups[t].values[e])for(var n=this.groups[t].values[e],i=0;n.length>i;i++)s.push(this.values[n[i]]);return s},hasGroupKey:function(t,e){return this.hasGroup(t)&&e in this.groups[t].values},getGroupKeys:function(t){return this.hasGroup(t)?Object.keys(this.groups[t].values):[]},removeGroup:function(t){return this._removeType("groups",t),this},destroy:function(){this.values=this.filters=this.maps=this.groups=null,this.add=this.filter=this.map=this.group=t.constantFunctions.ndef}});i._pathWrapper=function(t){return function(e){return n.path(e,t)}},i.sort=function(t,e,s){return(s?-1:1)*(t>e)?1:e>t?-1:0},i.pathSort=function(t,e){return t=t.split(","),function(s,r){for(var a=0,o=0;t.length>o&&0===a;o++)a=i.sort(n.path(s,t[o]),n.path(r,t[o]),e);return a}},i.filterPattern=function(t){return function(e){return n.eq(e,t)}},i.getOrderIndex=function(t,e,s,n){for(var i=(n?n:e).length,r=Math.ceil(i/2),a=r,o=null;r&&a>0&&i>=a&&(1!==r||-1!==o);){o=r;var u=n?e[n[a-1]]:e[a-1];r=Math.ceil(Math.abs(r)/2)*Math.sign(s(t,u))||1,a+=r}return a=Math.min(Math.max(a-1,0),i)},i.getSortedOrder=function(t,e){var s=[];return n.it(t,function(n,r){var a=i.getOrderIndex(n,t,e,s);s.splice(a,0,r)}),s},e("Organizer",i)})(Morgas,Morgas.setModule,Morgas.getModule);
//Math/TalePlay.Math.Point.js
(function(t,e){var i=window.TalePlay=window.TalePlay||{};i.Math=i.Math||{};var s=i.Math.Point=t.Class({init:function(t,e){this.x=0,this.y=0,this.set(t,e)},set:function(t,e){return"object"==typeof t&&null!==t?(this.x=1*t.x,this.y=1*t.y):"number"==typeof t&&(this.x=1*t,void 0===e&&(e=t),this.y=1*e),this},clone:function(t){return t||(t=new s),t.set(this.x,this.y),t},equals:function(t,e){return"object"==typeof t&&null!==t?this.x==t.x&&this.y==t.y:"number"==typeof t?(void 0===e&&(e=t),this.x==t&&this.y==e):!1},add:function(t,e){return"object"==typeof t&&null!==t?(this.x+=1*t.x,this.y+=1*t.y):"number"==typeof t&&(this.x+=1*t,void 0===e&&(e=t),this.y+=1*e),this},sub:function(t,e){return"object"==typeof t&&null!==t?(this.x-=t.x,this.y-=t.y):"number"==typeof t&&(this.x-=t,void 0===e&&(e=t),this.y-=e),this},mul:function(t,e){return"object"==typeof t&&null!==t?(this.x*=t.x,this.y*=t.y):"number"==typeof t&&(this.x*=t,void 0===e&&(e=t),this.y*=e),this},div:function(t,e){return"object"==typeof t&&null!==t?(this.x/=t.x,this.y/=t.y):"number"==typeof t&&(this.x/=t,void 0===e&&(e=t),this.y/=e),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},invert:function(){return this.x=1/this.x,this.y=1/this.y,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var t=this.length();return t&&this.div(t),this},getAngle:function(){if(0!==this.y||0!==this.x){var t=Math.asin(this.y/this.length());return this.x>=0?t=Math.PI/2-t:t+=1.5*Math.PI,t}return 0},doMath:function(t,e,i){return"object"==typeof e&&null!==e?(this.x=t(this.x,1*e.x),this.y=t(this.y,1*e.y)):"number"==typeof e&&(this.x=t(this.x,1*e),void 0===i&&(i=1*e),this.y=t(this.y,i)),this}});e("Math.Point",s)})(Morgas,Morgas.setModule,Morgas.getModule);
//Math/TalePlay.Math.Rect.js
(function(t,e,i){var s=window.TalePlay=window.TalePlay||{};s.Math=s.Math||{};var n=i("shortcut")({POINT:"Math.Point"}),o=s.Rect=t.Class({init:function(t,e){this.position=new n.POINT,this.size=new n.POINT,this.setPosition(t),this.setSize(e)},clone:function(){return new o(this.position,this.size)},setPosition:function(t,e){return this.position.set(t,e),this},setSize:function(t,e){return this.size.set(t,e),this},set:function(t,e,i,s){return this.position.set(t,e),this.size.set(i,s),this},setAbsolute:function(t,e,i,s){var n=Math.min(t,i),o=Math.min(e,s),a=Math.max(t,i);return Math.max(e,s),this.set(n,o,a-n,_y2-o),this},getAbsolute:function(){return{min:this.position.clone(),max:this.position.clone().add(this.size)}},collide:function(t){if(t===this)return!0;var e=this.getAbsolute(),i=t.getAbsolute();return!(e.min.x>=i.max.x||e.min.y>=i.max.y||i.min.x>=e.max.x||i.min.y>=e.max.y)},contains:function(t,e){var i=new n.POINT(t,e);return i.x>=this.position.x&&this.position.x+this.size.x>i.x&&i.y>=this.position.y&&this.position.y+this.size.y>i.y}});e("Math.Rect",o)})(Morgas,Morgas.setModule,Morgas.getModule);
//GUI/TalePlay.GUIElement.TextBox.js
(function(t,e,i){var s=i("GUIElement"),n=i("shortcut")({rs:"rescope"}),o=s.TextBox=t.Class(s,{init:function(t){n.rs.all(["_run"],this),t=t||{},this.superInit(s,t),this.addStyleClass("TextBox"),this.createListener("complete"),this.parts=[];for(var e=0,i=t.parts&&t.parts.length;i>e;e++){var o=t.parts[e];this.addPart(o.text,o.speed,o.stop,o.styleClass,o.tag)}this._timeout=null},addPart:function(t,e,i,s,n){this.parts.push({text:t||"",speed:1e3/e||25,stop:!!i,styleClass:s,tag:n||"span"})},start:function(){null===this._timeout&&(this.domElement.classList.remove("complete","stop"),this._run())},_run:function(){if(this._timeout=null,this.parts.length>0){var t=this.parts[0];if(t.domElement||(t.domElement=document.createElement(t.tag),t.styleClass&&t.domElement.classList.add(t.styleClass),this.domElement.appendChild(t.domElement)),t.domElement.textContent+=t.text[t.domElement.textContent.length],t.domElement.textContent.length===t.text.length&&(this.parts.shift(),t.stop))return this.domElement.classList.add("stop"),void 0;this._timeout=setTimeout(this._run,t.speed)}else this.domElement.classList.add("complete")},show:function(t){for(null!==this._timeout&&(clearTimeout(this._timeout),this._timeout=null);this.parts.length>0;){var e=this.parts[0];if(e.domElement||(e.domElement=document.createElement(e.tag),e.domElement.classList.add(e.styleClass),this.domElement.appendChild(e.domElement)),e.domElement.textContent=e.text,this.parts.splice(0,1),t&&e.stop)return this.domElement.classList.add("stop"),void 0}this.domElement.classList.add("complete")},onButton:function(t){1==t.value&&(null===this._timeout?0===this.parts.length?this.fire("complete"):this.start():this.show(!0))}});e("GUI.TextBox",o)})(Morgas,Morgas.setModule,Morgas.getModule);
//GUI/TalePlay.GUIElement.Menu.js
(function(t,e,i){var s=i("GUIElement"),n=i("shortcut")({MENU:"Menu",rescope:"rescope"}),o=s.Menu=t.Class(s,{init:function(t){n.rescope.all(["_stepActive","onClick"],this),t=t||{},this.superInit(s,t),this.menu=new n.MENU(t),this.addStyleClass("Menu"),this.domElement.addEventListener("click",this.onClick,!1),this.createListener("activeChanged select"),this.type=t.type||o.Types.VERTICAL,this.converter=t.converter||o.defaultConverter,this.converterInfo=t.converterInfo||{},this.rows=t.rows||null,this.columns=t.columns||null,this.header=t.header||null,this.stepDirection=null,this.stepID=null,this.stepDelay=t.stepDelay||500,this.stepAcceleration=Math.min(1/t.stepAcceleration,t.stepAcceleration)||.75,this.minStepDelay=t.minStepDelay||50,this.currentStepDelay=null,this.domElement.dataset.type=a[this.type],this.update()},onAnalogStick:function(t){var e=t.analogStick.clonePoint().doMath(Math.round,0);e.equals(this.stepDirection)||(this.stepID&&(clearTimeout(this.stepID),this.stepID=null),this.stepDirection=e,this._stepActive())},_stepActive:function(){var t=0;switch(this.type){case o.Types.VERTICAL:case o.Types.TABLE:t=-this.stepDirection.y;break;case o.Types.GRID:var e=this.getGridLayout();if(1===this.stepDirection.y){if(t=-e.columns,0>this.menu.active+t){var i=this.menu.items.length%e.columns;t=0===i||i>this.menu.active?-i:t-i}}else-1===this.stepDirection.y&&(t=e.columns,this.menu.active+t>=this.menu.items.length&&(t=this.menu.active%e.columns,t=this.menu.items.length-this.menu.active+t));case o.Types.HORIZONTAL:t+=this.stepDirection.x}0!==t?(this.menu.moveActive(t),this._updateActive(),this.fire("activeChanged"),null===this.stepID?this.currentStepDelay=this.stepDelay:this.currentStepDelay!==this.minStepDelay&&(this.currentStepDelay=Math.max(this.minStepDelay,this.currentStepDelay*this.stepAcceleration)),this.stepID=setTimeout(this._stepActive,this.currentStepDelay)):(clearTimeout(this.stepID),this.stepDirection=this.stepID=null)},_updateActive:function(){for(var t=0,e=this.domElement.querySelectorAll(".menuitem.active");e.length>t;t++)e[t].classList.remove("active");-1!==this.menu.active&&this.getItemDomElement(this.menu.active).classList.add("active")},onClick:function(t){var e=t.target,i=-1;if("INPUT"!==e.tagName&&"SELECT"!==e.tagName&&"TEXTAREA"!==e.tagName){for(;e&&e!==document&&!e.classList.contains("menuitem");)e=e.parentNode;if(this.type===o.Types.GRID){var s=Array.prototype.indexOf.call(e.parentNode.children,e),n=Array.prototype.indexOf.call(this.domElement.children,e.parentNode),a=this.getGridLayout();i=n*a.columns+s}else i=this.type===o.Types.TABLE&&this.header?Array.prototype.indexOf.call(this.domElement.children,e)-1:Array.prototype.indexOf.call(this.domElement.children,e);i>-1&&(t.stopPropagation(),this.layer&&this.layer.board&&this.layer.board.focus(),this.setActive(i),this.toggleSelect(i))}},onButton:function(t){1===t.value&&-1!==this.menu.active&&this.toggleSelect(this.menu.active)},toggleSelect:function(t){var e=this.getItemDomElement(t).classList;this.menu.selectionType===n.MENU.SelectionTypes.SINGLE&&!this.menu.isSelected(t)&&this.menu.selectedIndexs.length>0&&this.getItemDomElement(this.menu.selectedIndexs[0]).classList.remove("selected"),this.menu.toggleSelect(t,!0)?e.add("selected"):e.remove("selected"),this.fire("select",this.menu.getItem(t))},getGridLayout:function(){var t={rows:this.rows,columns:this.columns};return null===t.rows&&null===t.columns&&(t.columns=Math.ceil(Math.sqrt(this.menu.items.length))),null==t.rows?t.rows=Math.ceil(this.menu.items.length/t.columns):null==t.columns&&(t.columns=Math.ceil(this.menu.items.length/t.rows)),t},update:function(){if(this.domElement.innerHTML="",this.type===o.Types.TABLE&&this.header&&(this.domElement.innerHTML='<span class="menuheader"><span>'+this.header.join("</span><span>")+"</span></span>"),this.type===o.Types.GRID&&this.menu.items.length>0)for(var t=this.getGridLayout(),e=0,i=document.createElement("span");t.rows>e;e++,i=document.createElement("span")){i.classList.add("row"),this.domElement.appendChild(i);for(var s=0,n=e*t.columns;t.columns>s&&this.menu.items.length>n;s++,n=e*t.columns+s)i.appendChild(this.convertItem(this.menu.items[n],n))}else for(var a=0;this.menu.items.length>a;a++)this.domElement.appendChild(this.convertItem(this.menu.items[a],a))},convertItem:function(t,e){var i=this.converter(t,e,this.converterInfo),s=null;return i instanceof HTMLElement?s=i:(s=document.createElement("span"),Array.isArray(i)&&(i="<span>"+i.join("</span><span>")+"</span>"),s.innerHTML=i),s.classList.add("menuitem"),this.menu.isSelected(t)&&s.classList.add("selected"),this.menu.isDisabled(t)&&s.classList.add("disabled"),this.menu.active===e&&s.classList.add("active"),s},addItem:function(t){return this.menu.addItem(t),this.type===o.Types.GRID?update():this.domElement.appendChild(this.convertItem(t,this.menu.items.length-1)),this},addAll:function(t){for(var e=0;t.length>e;e++)this.addItem(t[e]);return this},removeItem:function(t){var e=this.menu.removeItem(t);return-1!==e&&this.getItemDomElement(e).remove(),e},getItemDomElement:function(t){if(this.type===o.Types.GRID){var e=this.getGridLayout(),i=Math.floor(t/e.columns),s=t-i*e.columns;return this.domElement.children[i].children[s]}return this.type===o.Types.TABLE&&this.header?this.domElement.children[t+1]:this.domElement.children[t]},getItem:function(t){var e=this.menu.getItem(t);return e.domElement=this.getItemDomElement(t),e},getSelectedItems:function(){for(var t=[],e=0;this.menu.selectedIndexs.length>e;e++)t.push(this.getItem(this.menu.selectedIndexs[e]));return t},clear:function(){for(this.menu.clear();!this.header&&this.domElement.lastChild||this.domElement.lastChild!==this.domElement.firstChild;)this.domElement.lastChild.remove();return this},getActive:function(){return this.getItem(this.menu.active)},setActive:function(t){this.menu.setActive(t),this._updateActive()}});i("shortcut")({SelectionTypes:function(){return i("Menu").SelectionTypes}},o),o.Types={VERTICAL:1,HORIZONTAL:2,TABLE:3,GRID:4},o.defaultConverter=function(t){return""+t};var a={};for(var r in o.Types)a[o.Types[r]]=[r];e("GUI.Menu",o)})(Morgas,Morgas.setModule,Morgas.getModule);
//TalePlay.Menu.js
(function(t,e){var i=window.TalePlay=window.TalePlay||{},s=i.Menu=t.Class({init:function(t){if(t=t||{},this.items=t.items||[],this.selectionType=t.selectionType||s.SelectionTypes.MULTI,this.loop=t.loop!==!1,this.selectedIndexs=[],this.disabledIndexs=[],this.active=-1,void 0!==t.active&&t.active>-1&&this.items.length>t.active&&(this.active=t.active),void 0!==t.selected)for(var e=0;t.selected.length>e;e++)this.addSelect(t.selected[e]);if(void 0!==t.disabled)for(var e=0;t.disabled.length>e;e++)this.setDisabled(t.disabled[e],!0)},addItem:function(t){return this.items.push(t),this},addAll:function(t){for(var e=0;t.length>e;e++)this.addItem(t[e]);return this},removeItem:function(t){var e=this.items.indexOf(t);if(-1!==e){this.items.splice(e,1);var i=this.selectedIndexs.indexOf(e);-1!==i&&this.selectedIndexs.splice(i,1);var s=this.disabledIndexs.indexOf(e);-1!==s&&this.disabledIndexs.splice(i,1),this.active>e?this.active--:this.active===e&&this.setActive(-1)}return e},getItem:function(t){return{index:t,value:this.items[t],active:this.active===t,selected:-1!==this.selectedIndexs.indexOf(t),disabled:-1!==this.disabledIndexs.indexOf(t)}},clearSelect:function(){this.selectedIndexs.length=0},isSelected:function(t){var e=this.items.indexOf(t);return-1===e&&(e=t),-1!==this.selectedIndexs.indexOf(e)},addSelect:function(t){if(this.selectionType===s.SelectionTypes.NONE)return!1;var e=this.items.indexOf(t);return-1===e&&(e=t),this.items.hasOwnProperty(e)&&-1===this.selectedIndexs.indexOf(e)?(this.selectionType===s.SelectionTypes.SINGLE?this.selectedIndexs[0]=e:this.selectedIndexs.push(e),!0):!1},removeSelect:function(t){var e=this.items.indexOf(t);return-1===e&&(e=t),e=this.selectedIndexs.indexOf(e),-1!==e?(this.selectedIndexs.splice(e,1),!0):!1},toggleSelect:function(t,e){if(this.selectionType===s.SelectionTypes.NONE)return!1;var i=e?t:this.items.indexOf(t);if(-1===i&&(i=t),this.items.hasOwnProperty(i)){var n=this.selectedIndexs.indexOf(i);return-1===n?(this.selectionType===s.SelectionTypes.SINGLE?this.selectedIndexs[0]=i:this.selectedIndexs.push(i),!0):(this.selectedIndexs.splice(n,1),!1)}return null},getActive:function(){return this.getItem(this.active)},setActive:function(t){var e=-1,i=this.items.length-1;t=t>=e?t>i?i:t:e,this.active!==t&&(this.active=t)},moveActive:function(t){var e=this.active+t;this.loop?(-1===this.active&&0>t&&e++,e%=this.items.length,0>e&&(e=this.items.length+e)):e=0>e?0:e,this.setActive(e)},toggleActive:function(){return this.toggleSelect(this.active)},getSelectedItems:function(){for(var t=[],e=0;this.selectedIndexs.length>e;e++)t.push(this.getItem(this.selectedIndexs[e]));return t},setDisabled:function(t){var e=this.items.indexOf(t);return-1===e&&(e=t),this.items.hasOwnProperty(e)&&-1===this.disabledIndexs.indexOf(e)?(this.disabledIndexs.push(e),!0):!1},isDisabled:function(t){var e=this.items.indexOf(t);return-1===e&&(e=t),-1!==this.disabledIndexs.indexOf(e)},getType:function(){return this.selectionType},setType:function(t){switch(t){case s.SelectionTypes.NONE:this.selectedIndexs.length=0;break;case s.SelectionTypes.SINGLE:this.selectedIndexs.length=1}this.selectionType=t},clear:function(){return this.items.length=this.selectedIndexs.lengt=this.disabledIndexs.length=0,this.active=-1,this}});s.SelectionTypes={NONE:1,SINGLE:2,MULTI:3},e("Menu",s)})(Morgas,Morgas.setModule,Morgas.getModule);