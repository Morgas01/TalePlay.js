(function(t,e,i){var s=i("GUIElement"),n=i("shortcut")({MENU:"Menu",rescope:"rescope"}),o=s.Menu=t.Class(s,{init:function(t){n.rescope.all(["_stepActive","onClick"],this),t=t||{},this.superInit(s,t),this.menu=new n.MENU(t),this.addStyleClass("Menu"),this.domElement.addEventListener("click",this.onClick,!1),this.createListener("activeChanged select"),this.type=t.type||o.Types.VERTICAL,this.converter=t.converter||o.defaultConverter,this.converterInfo=t.converterInfo||{},this.rows=t.rows||null,this.columns=t.columns||null,this.header=t.header||null,this.stepDirection=null,this.stepID=null,this.stepDelay=t.stepDelay||500,this.stepAcceleration=Math.min(1/t.stepAcceleration,t.stepAcceleration)||.75,this.minStepDelay=t.minStepDelay||50,this.currentStepDelay=null,this.domElement.dataset.type=a[this.type],this.update()},onAnalogStick:function(t){var e=t.analogStick.clonePoint().doMath(Math.round,0);e.equals(this.stepDirection)||(this.stepID&&(clearTimeout(this.stepID),this.stepID=null),this.stepDirection=e,this._stepActive())},_stepActive:function(){var t=0;switch(this.type){case o.Types.VERTICAL:case o.Types.TABLE:t=-this.stepDirection.y;break;case o.Types.GRID:var e=this.getGridLayout();if(1===this.stepDirection.y){if(t=-e.columns,0>this.menu.active+t){var i=this.menu.items.length%e.columns;t=0===i||i>this.menu.active?-i:t-i}}else-1===this.stepDirection.y&&(t=e.columns,this.menu.active+t>=this.menu.items.length&&(t=this.menu.active%e.columns,t=this.menu.items.length-this.menu.active+t));case o.Types.HORIZONTAL:t+=this.stepDirection.x}0!==t?(this.menu.moveActive(t),this._updateActive(),this.fire("activeChanged"),null===this.stepID?this.currentStepDelay=this.stepDelay:this.currentStepDelay!==this.minStepDelay&&(this.currentStepDelay=Math.max(this.minStepDelay,this.currentStepDelay*this.stepAcceleration)),this.stepID=setTimeout(this._stepActive,this.currentStepDelay)):(clearTimeout(this.stepID),this.stepDirection=this.stepID=null)},_updateActive:function(){for(var t=0,e=this.domElement.querySelectorAll(".menuitem.active");e.length>t;t++)e[t].classList.remove("active");-1!==this.menu.active&&this.getItemDomElement(this.menu.active).classList.add("active")},onClick:function(t){var e=t.target,i=-1;if("INPUT"!==e.tagName&&"SELECT"!==e.tagName&&"TEXTAREA"!==e.tagName){for(;e&&e!==document&&!e.classList.contains("menuitem");)e=e.parentNode;if(this.type===o.Types.GRID){var s=Array.prototype.indexOf.call(e.parentNode.children,e),n=Array.prototype.indexOf.call(this.domElement.children,e.parentNode),a=this.getGridLayout();i=n*a.columns+s}else i=this.type===o.Types.TABLE&&this.header?Array.prototype.indexOf.call(this.domElement.children,e)-1:Array.prototype.indexOf.call(this.domElement.children,e);i>-1&&(t.stopPropagation(),this.layer&&this.layer.board&&this.layer.board.focus(),this.setActive(i),this.toggleSelect(i))}},onButton:function(t){1===t.value&&-1!==this.menu.active&&this.toggleSelect(this.menu.active)},toggleSelect:function(t){var e=this.getItemDomElement(t).classList;this.menu.selectionType===n.MENU.SelectionTypes.SINGLE&&!this.menu.isSelected(t)&&this.menu.selectedIndexs.length>0&&this.getItemDomElement(this.menu.selectedIndexs[0]).classList.remove("selected"),this.menu.toggleSelect(t,!0)?e.add("selected"):e.remove("selected"),this.fire("select",this.menu.getItem(t))},getGridLayout:function(){var t={rows:this.rows,columns:this.columns};return null===t.rows&&null===t.columns&&(t.columns=Math.ceil(Math.sqrt(this.menu.items.length))),null==t.rows?t.rows=Math.ceil(this.menu.items.length/t.columns):null==t.columns&&(t.columns=Math.ceil(this.menu.items.length/t.rows)),t},update:function(){if(this.domElement.innerHTML="",this.type===o.Types.TABLE&&this.header&&(this.domElement.innerHTML='<span class="menuheader"><span>'+this.header.join("</span><span>")+"</span></span>"),this.type===o.Types.GRID&&this.menu.items.length>0)for(var t=this.getGridLayout(),e=0,i=document.createElement("span");t.rows>e;e++,i=document.createElement("span")){i.classList.add("row"),this.domElement.appendChild(i);for(var s=0,n=e*t.columns;t.columns>s&&this.menu.items.length>n;s++,n=e*t.columns+s)i.appendChild(this.convertItem(this.menu.items[n],n))}else for(var a=0;this.menu.items.length>a;a++)this.domElement.appendChild(this.convertItem(this.menu.items[a],a))},convertItem:function(t,e){var i=this.converter(t,e,this.converterInfo),s=null;return i instanceof HTMLElement?s=i:(s=document.createElement("span"),Array.isArray(i)&&(i="<span>"+i.join("</span><span>")+"</span>"),s.innerHTML=i),s.classList.add("menuitem"),this.menu.isSelected(t)&&s.classList.add("selected"),this.menu.isDisabled(t)&&s.classList.add("disabled"),this.menu.active===e&&s.classList.add("active"),s},addItem:function(t){return this.menu.addItem(t),this.type===o.Types.GRID?update():this.domElement.appendChild(this.convertItem(t,this.menu.items.length-1)),this},addAll:function(t){for(var e=0;t.length>e;e++)this.addItem(t[e]);return this},removeItem:function(t){var e=this.menu.removeItem(t);return-1!==e&&this.getItemDomElement(e).remove(),e},getItemDomElement:function(t){if(this.type===o.Types.GRID){var e=this.getGridLayout(),i=Math.floor(t/e.columns),s=t-i*e.columns;return this.domElement.children[i].children[s]}return this.type===o.Types.TABLE&&this.header?this.domElement.children[t+1]:this.domElement.children[t]},getItem:function(t){var e=this.menu.getItem(t);return e.domElement=this.getItemDomElement(t),e},getSelectedItems:function(){for(var t=[],e=0;this.menu.selectedIndexs.length>e;e++)t.push(this.getItem(this.menu.selectedIndexs[e]));return t},clear:function(){for(this.menu.clear();!this.header&&this.domElement.lastChild||this.domElement.lastChild!==this.domElement.firstChild;)this.domElement.lastChild.remove();return this},getActive:function(){return this.getItem(this.menu.active)},setActive:function(t){this.menu.setActive(t),this._updateActive()}});i("shortcut")({SelectionTypes:function(){return i("Menu").SelectionTypes}},o),o.Types={VERTICAL:1,HORIZONTAL:2,TABLE:3,GRID:4},o.defaultConverter=function(t){return""+t};var a={};for(var r in o.Types)a[o.Types[r]]=[r];e("GUI.Menu",o)})(Morgas,Morgas.setModule,Morgas.getModule);