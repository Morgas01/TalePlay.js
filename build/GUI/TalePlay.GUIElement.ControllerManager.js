(function(t,e,i){var n=i("GUIElement"),s=i("shortcut")({rs:"rescope",bind:"bind",mapping:"Controller.Mapping",ctrlK:"Controller.Keyboard",ctrlG:"Controller.Gamepad",GMenu:"GUI.Menu",config:"GUI.ControllerConfig"}),a='<table><tr><td class="DeviceActions"><select class="devices"></select><button data-action="addDevice">add Device</button><button data-action="removeController">remove Controller</button></td><td class="MappingActions"><button data-action="newMapping">New</button><button data-action="setMapping">Set</button><button data-action="editMapping">Edit</button><button data-action="deleteMapping">Delete</button></td></tr><tr><td class="controllers"></td><td class="mappings"></td></tr></table><button data-action="close">OK</button>',o=n.ControllerManager=t.Class(n,{init:function(t){t=t||{},t.styleClass=t.styleClass||"overlay",this.superInit(n,t),this.addStyleClass("ControllerManager"),s.rs.all(["_Click","_playerChanged","_mappingsLoaded"],this),this.domElement.addEventListener("click",this._Click),this.buttons=void 0!==t.buttons?t.buttons:10,this.analogSticks=void 0!==t.analogSticks?t.analogSticks:2,this.controllers=new s.GMenu({type:s.GMenu.Types.TABLE,header:["No.","Device","Mapping","Player"],selectionType:s.GMenu.SelectionTypes.SINGLE,converter:o.controllerConverter}),this.controllers.addListener("select",this,"_MenuSelect"),t.mappings=t.mappings||[],t.mappings.unshift(null),this.mappings=new s.GMenu({type:s.GMenu.Types.TABLE,header:["Name","Type"],selectionType:s.GMenu.SelectionTypes.SINGLE,converter:o.mappingConverter,items:t.mappings}),this.mappings.addListener("select",this,"_MenuSelect"),this.dbConn=t.dbConn||null,this.dbConn&&this.dbConn.load(s.mapping,{}).complete(this._mappingsLoaded),this.config=null,this.domElement.innerHTML=a,this.domElement.querySelector(".controllers").addEventListener("change",this._playerChanged),this.domElement.querySelector(".controllers").appendChild(this.controllers.domElement),this.domElement.querySelector(".mappings").appendChild(this.mappings.domElement),this.update(),this._gamepadListener=s.bind(this.update,this,"devices"),window.addEventListener("gamepadconnected",this._gamepadListener)},update:function(t){if(void 0===t||"devices"===t){for(var e="<option>Keyboard</option>",i=navigator.getGamepads(),n=0;i.length>n;n++)i[n]&&(e+="<option>"+i[n].id+"</option>");this.domElement.querySelector(".devices").innerHTML=e}if(this.layer&&this.layer.board&&(void 0===t||"controllers"===t)&&this.controllers.clear().addAll(this.layer.board.controllers),void 0===t||"actions"===t){var s=this.controllers.getSelectedItems()[0],a=this.mappings.getSelectedItems()[0];this.domElement.querySelector('[data-action="removeController"]').disabled=this.domElement.querySelector('[data-action="newMapping"]').disabled=!s,this.domElement.querySelector('[data-action="setMapping"]').disabled=!s||!a,this.domElement.querySelector('[data-action="editMapping"]').disabled=!s||!s.value.controller.getMapping(),this.domElement.querySelector('[data-action="deleteMapping"]').disabled=!a}},_mappingsLoaded:function(t){this.mappings.addAll(t)},_Click:function(t){var e=t.target.dataset.action;void 0!==e&&(t.stopPropagation(),this[e]())},addDevice:function(){var t=this.domElement.querySelector(".devices").selectedIndex;if(0===t)this.addController(new s.ctrlK);else{var e=navigator.getGamepads()[--t];this.addController(new s.ctrlG(e))}},removeController:function(){var t=this.controllers.getSelectedItems()[0];t&&(this.layer.board.removeController(t.value.controller),this.update("controllers"))},newMapping:function(){this._openControllerConfig(!0)},setMapping:function(){var t=this.controllers.getSelectedItems()[0],e=this.mappings.getSelectedItems()[0];t&&e&&(t.value.controller.setMapping(e.value),this.update("controllers"))},editMapping:function(){this._openControllerConfig(!1)},deleteMapping:function(){var t=this.mappings.getSelectedItems()[0];t&&null!==t.value&&(this.mappings.removeItem(t.value),this.dbConn&&void 0!==t.value.getID()&&this.dbConn["delete"](s.mapping,t.value))},addController:function(t){this.layer.board.addController(t),this.update("controllers")},_MenuSelect:function(){this.update("actions")},_openControllerConfig:function(t){var e=this.controllers.getSelectedItems()[0];if(e&&!this.config){e=e.value.controller;var i=e.getMapping();if(this.config=new s.config({buttons:this.buttons,analogSticks:this.analogSticks,controller:e,name:!!t}),t)e.setMapping(null);else if(!i)return!1;return this.config.addStyleClass("panel","overlay"),this.layer.add(this.config),this.config.addListener("submit:once",this,function(n){switch(!0){case"ok"===n.value:t?(i=n.source.getMapping(),this.mappings.addItem(i)):i.setValueOf("data",n.source.getData()),this.dbConn&&(t||void 0!==i.getID())&&this.dbConn.save(i);case!!t:e.setMapping(i)}n.source.destroy(),this.config=null,this.update("controllers")}),!0}return!1},close:function(){this.layer&&this.layer.board&&this.layer.board.focus(),this.destroy()},_playerChanged:function(t){void 0!==t.target.dataset.controllerindex&&(this.layer.board.controllers[t.target.dataset.controllerindex].player=1*t.target.value||1)},destroy:function(){n.prototype.destroy.call(this),window.removeEventListener("gamepadconnected",this._gamepadListener)}});o.controllerConverter=function(t,e){return[e,t.controller instanceof s.ctrlK?"Keyboard":t.controller.gamepad.id,t.controller.mapping&&t.controller.mapping.getValueOf("name")||"None",'<input type="number" min="1" value="'+t.player+'" data-controllerindex="'+e+'" >']},o.mappingConverter=function(t){return t?[t.getValueOf("name"),t.getValueOf("type")]:["none",""]},e("GUI.ControllerManager",o)})(Morgas,Morgas.setModule,Morgas.getModule);