(function(t,e,i){var s=this.TalePlay=this.TalePlay||{},n=i("Listeners"),o=i("Math.Point"),r=t.shortcut({mapping:"Controller.Mapping"}),a=s.Controller=t.Class(n,{init:function(t,e){this.superInit(n),this.disabled=!1,this.analogSticks={},this.buttons={},this.mapping=null,this.setMapping(t,e),this.createListener("changed analogStickChanged buttonChanged")},getMapping:function(){return this.mapping},setMapping:function(t,e){t?(t instanceof r.mapping||(t=new r.mapping({data:t,name:e||"default"})),this.mapping=t):this.mapping=null},getAnalogStick:function(t){return void 0===this.analogSticks[t]&&(this.analogSticks[t]=new a.AnalogStick),this.analogSticks[t]},setButton:function(t){var e=!1,i=void 0;if(this.mapping){var s={};i={};for(var n in t){var o=this.mapping.getButtonAxisMapping(n);void 0!==o?i[Math.abs(o)]=this.mapping.convertAxisValue(o,t[n]):s[this.mapping.getButtonMapping(n)]=t[n]}t=s}for(var r in t){var a=t[r];if(void 0===this.buttons[r]||this.buttons[r]!==a){var l=this.buttons[r]||0;this.buttons[r]=a,this.fire("buttonChanged",{index:1*r,value:a,oldValue:l}),e=!0}}return i&&(e=this.setAxis(i,!0)||e),e&&this.fire("changed"),e},setAxis:function(t,e){var i=!1;if(this.mapping&&!e){var s={};for(var n in t){var o=this.mapping.getAxisMapping(n);s[Math.abs(o)]=this.mapping.convertAxisValue(o,t[n])}t=s}for(var r=Object.keys(t);r.length>0;){var a=r.shift(),l=void 0,h=void 0;o=-1;var d=this.getAnalogStick(a>>1);0==a%2?(l=t[a],h=t[1*a+1]||d.y,o=r.indexOf(1*a+1),-1!==o&&r.splice(o,1)):(l=t[a-1]||d.x,h=t[a],o=r.indexOf(a-1),-1!==o&&r.splice(o,1)),d.set(l,h),d.hasChanged()&&(i=!0,this.fire("analogStickChanged",{index:a>>1,analogStick:d}))}return i&&!e&&this.fire("changed"),i},set:function(t,e){this.setButton(t),this.setAxis(e)},setDisabled:function(t){this.disabled=t===!0;for(var e in this.listeners)this.listeners[e].setDisabled(this.disabled)},destroy:function(){},toString:function(){return JSON.stringify(this)},toJSON:function(){return{buttons:this.buttons,analogSticks:this.analogSticks}}});a.AnalogStick=t.Class(o,{init:function(t,e){this.old={x:0,y:0},this.superInit(o,t,e)},clone:function(t){return t||(t=new a.AnalogStick),o.prototype.clone.call(this,t),t.old.x=this.old.x,t.old.y=this.old.y,t},clonePoint:function(){return o.prototype.clone.call(this)},pushOld:function(){return this.old.x=this.x,this.old.y=this.y,this},hasChanged:function(){return!this.equals(this.old)},getDifference:function(){return new o(this.old).sub(this)},setComponent:function(t,e){return this.pushOld(),0===t%2?this.x=e:this.y=e,this},set:function(t,e){this.pushOld(),o.prototype.set.call(this,t,e)}}),e("Controller",a)})(Morgas,Morgas.setModule,Morgas.getModule);